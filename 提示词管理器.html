<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示词管理器</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6789b8;
            --bg-color: #f5f7fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --tag-color: #e1f5fe;
            --tag-text: #0277bd;
            --sidebar-width: 220px;
            --sidebar-bg: #f0f4f8;
            --select-color: rgba(74, 111, 165, 0.15);
            --group-header-bg: #ebf2fa;
            --group-border: #d1e1f5;
            --tag-bg: #edf7ff;
            --tag-primary: #4a90e2;
            --count-bg: #e3e9f2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        /* 左侧分类栏 */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            padding: 20px 15px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar h2 button {
            font-size: 12px;
            padding: 3px 6px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-list {
            list-style: none;
        }

        .sidebar-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-item:hover {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .sidebar-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .sidebar-item.active .count {
            background-color: white;
            color: var(--primary-color);
        }

        .tag-sidebar-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tag-sidebar-item:hover {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .tag-sidebar-item.active {
            background-color: var(--tag-bg);
            color: var(--tag-primary);
            border-left: 3px solid var(--tag-primary);
        }

        .tag-sidebar-item .tag-icon {
            width: 8px;
            height: 8px;
            background-color: var(--tag-primary);
            border-radius: 50%;
            margin-right: 8px;
        }

        .tag-sidebar-item .tag-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .count {
            background-color: var(--count-bg);
            color: var(--text-color);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 25px;
            text-align: center;
        }

        .sidebar-search {
            margin-bottom: 10px;
            position: relative;
        }

        .sidebar-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .sidebar-search .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 14px;
            display: none;
        }

        .sidebar-search input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-right: 15px;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            width: 100%;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 13px;
        }

        #sort-options, #group-options {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            font-size: 14px;
        }

        #drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            background-color: var(--card-color);
            cursor: pointer;
            transition: border-color 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #drop-area:hover {
            border-color: var(--primary-color);
        }

        #drop-area.highlight {
            border-color: var(--primary-color);
            background-color: rgba(74, 111, 165, 0.1);
        }

        #drop-area p {
            margin: 0;
            font-size: 14px;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
            flex: 1;
            min-width: 200px;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        #search-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .group-header {
            background-color: var(--group-header-bg);
            padding: 10px 15px;
            border-radius: 5px;
            margin: 25px 0 15px 0;
            font-weight: bold;
            color: var(--primary-color);
            border-left: 5px solid var(--group-border);
        }

        .group-header:first-child {
            margin-top: 0;
        }

        .prompt-group {
            margin-bottom: 15px;
        }

        .prompt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .prompt-card {
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .prompt-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .prompt-card.selected {
            background-color: var(--select-color);
            border: 2px solid var(--primary-color);
        }

        .prompt-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-content {
            white-space: pre-wrap;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .prompt-category {
            display: inline-block;
            background-color: var(--tag-color);
            color: var(--tag-text);
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 10px;
            margin-right: 5px;
        }

        .prompt-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .prompt-tag {
            display: inline-block;
            background-color: var(--tag-bg);
            color: var(--tag-primary);
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid var(--tag-primary);
        }

        .tag-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            background-color: var(--tag-bg);
            border: 1px solid var(--tag-primary);
            border-radius: 12px;
            padding: 3px 5px 3px 8px;
        }

        .tag-text {
            color: var(--tag-primary);
            font-size: 12px;
            margin-right: 5px;
        }

        .tag-remove {
            width: 16px;
            height: 16px;
            background-color: var(--tag-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        .list-view .prompt-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list-view .prompt-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }

        .list-view .prompt-title {
            margin-bottom: 0;
            flex: 1;
        }

        .list-view .prompt-content {
            display: none;
        }

        .list-view .prompt-category, .list-view .prompt-tags {
            margin-left: 10px;
            margin-top: 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .edit-btn {
            background-color: #ffc107;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background-color: #ffa000;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
        }

        #modal, #category-manager, #multi-action-modal, #tags-modal, #tags-manager {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .category-content, .tags-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .category-list, .tags-list {
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-item, .tag-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-color);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .tag-manager-item span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tag-manager-item .tag-dot {
            width: 8px;
            height: 8px;
            background-color: var(--tag-primary);
            border-radius: 50%;
        }

        .add-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-form input {
            flex: 1;
            padding: 8px 12px;
        }

        .tags-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .tags-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        /* 多选操作相关样式 */
        .bulk-actions {
            display: none;
            background-color: var(--primary-color);
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: space-between;
            color: white;
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bulk-count {
            font-weight: bold;
        }

        .bulk-actions-right {
            display: flex;
            gap: 10px;
        }

        .bulk-action-btn {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .bulk-action-btn:hover {
            background-color: #f0f0f0;
        }

        .bulk-action-btn.danger {
            background-color: #f44336;
            color: white;
        }

        .bulk-action-btn.danger:hover {
            background-color: #d32f2f;
        }

        .checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
        }

        .prompt-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 15px;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .prompt-grid {
                grid-template-columns: 1fr;
            }
            
            #drop-area {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 10px;
            }

            .bulk-actions-right {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* 移动设备菜单按钮 */
        .menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                z-index: 900;
                transition: left 0.3s;
                width: 80%;
                max-width: 300px;
            }
            
            .sidebar.active {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- 左侧分类栏 -->
    <div class="sidebar" id="sidebar">
        <!-- 分类部分 -->
        <div class="sidebar-section">
            <h2>
                分类
                <button id="manage-categories-btn">管理</button>
            </h2>
            <ul class="sidebar-list" id="category-sidebar-list">
                <li class="sidebar-item active" data-category="all">
                    <span>所有分类</span>
                    <span class="count">0</span>
                </li>
                <!-- 分类会通过JavaScript动态添加 -->
            </ul>
        </div>

        <!-- 标签部分 -->
        <div class="sidebar-section">
            <h2>
                标签
                <button id="manage-tags-btn">管理</button>
            </h2>
            <div class="sidebar-search">
                <input type="text" id="tag-search-input" placeholder="搜索标签...">
                <span class="clear-search" id="clear-tag-search">&times;</span>
            </div>
            <ul class="sidebar-list" id="tag-sidebar-list">
                <!-- 标签会通过JavaScript动态添加 -->
            </ul>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <header>
            <h1>提示词管理器</h1>
        </header>

        <!-- 批量操作工具栏 -->
        <div class="bulk-actions" id="bulk-actions">
            <div class="bulk-actions-left">
                <span>已选择 <span class="bulk-count" id="bulk-count">0</span> 个提示词</span>
                <button class="bulk-action-btn" id="cancel-select-btn">取消选择</button>
            </div>
            <div class="bulk-actions-right">
                <button class="bulk-action-btn" id="bulk-category-btn">设置分类</button>
                <button class="bulk-action-btn" id="bulk-tags-btn">设置标签</button>
                <button class="bulk-action-btn danger" id="bulk-delete-btn">批量删除</button>
            </div>
        </div>

        <div class="controls-row">
            <div class="control-group">
                <button id="new-prompt-btn">新建提示词</button>
                <button id="select-mode-btn" class="btn-small">多选模式</button>
                <select id="sort-options">
                    <option value="newest">最新添加</option>
                    <option value="oldest">最早添加</option>
                    <option value="alpha-asc">标题 A-Z</option>
                    <option value="alpha-desc">标题 Z-A</option>
                </select>
            </div>

            <div id="drop-area">
                <p>拖放Markdown文件到这里</p>
                <button id="file-select-btn" class="btn-small">选择文件</button>
                <input type="file" id="file-input" accept=".md" style="display: none;">
            </div>

            <div class="control-group">
                <select id="group-options">
                    <option value="none">不分组</option>
                    <option value="category">按分类分组</option>
                    <option value="tags">按标签分组</option>
                </select>
                <button id="card-view-btn" class="btn-small">卡片视图</button>
                <button id="list-view-btn" class="btn-small">列表视图</button>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="搜索提示词...">
        </div>

        <div id="prompt-container"></div>
    </div>

    <!-- 移动设备菜单按钮 -->
    <div class="menu-toggle" id="menu-toggle">☰</div>

    <div class="toast" id="toast">已复制到剪贴板</div>

    <div id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">新建提示词</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="prompt-title-input">标题</label>
                <input type="text" id="prompt-title-input" placeholder="输入提示词标题">
            </div>
            <div class="form-group">
                <label for="prompt-category-input">分类</label>
                <select id="prompt-category-input">
                    <option value="">未分类</option>
                </select>
            </div>
            <div class="form-group">
                <label for="prompt-tags-input">标签 (多个标签用逗号分隔)</label>
                <input type="text" id="prompt-tags-input" placeholder="输入标签，如: 工作,翻译,AI">
                <div class="tag-container" id="prompt-tags-container"></div>
            </div>
            <div class="form-group">
                <label for="prompt-content-input">内容</label>
                <textarea id="prompt-content-input" placeholder="输入提示词内容"></textarea>
            </div>
            <button id="save-prompt-btn">保存</button>
        </div>
    </div>

    <div id="category-manager">
        <div class="category-content">
            <div class="modal-header">
                <h2>管理分类</h2>
                <button class="close-category-manager">&times;</button>
            </div>
            <div class="category-list" id="category-list"></div>
            <div class="add-form">
                <input type="text" id="new-category-input" placeholder="新分类名称">
                <button id="add-category-btn">添加</button>
            </div>
        </div>
    </div>

    <div id="tags-manager">
        <div class="tags-content">
            <div class="modal-header">
                <h2>管理标签</h2>
                <button class="close-tags-manager">&times;</button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="tag-manager-search" placeholder="搜索标签...">
                <span class="clear-search" id="clear-tag-manager-search">&times;</span>
            </div>
            <div class="tags-list" id="tags-manager-list"></div>
            <div class="add-form">
                <input type="text" id="new-tag-input" placeholder="新标签名称">
                <button id="add-tag-btn">添加</button>
            </div>
        </div>
    </div>

    <div id="multi-action-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置分类</h2>
                <button class="close-multi-action-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="bulk-category-select">选择分类</label>
                <select id="bulk-category-select">
                    <option value="">未分类</option>
                </select>
            </div>
            <button id="apply-bulk-category-btn">应用</button>
        </div>
    </div>

    <div id="tags-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置标签</h2>
                <button class="close-tags-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="bulk-tags-input">输入标签 (多个标签用逗号分隔)</label>
                <input type="text" id="bulk-tags-input" placeholder="输入标签，如: 工作,翻译,AI">
                <div class="tag-container" id="bulk-tags-container"></div>
            </div>
            <div class="form-group">
                <label>操作方式</label>
                <select id="tags-action-mode">
                    <option value="replace">替换所有标签</option>
                    <option value="add">添加标签</option>
                    <option value="remove">移除标签</option>
                </select>
            </div>
            <button id="apply-bulk-tags-btn">应用</button>
        </div>
    </div>

    <script>
        // DOM元素
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const promptContainer = document.getElementById('prompt-container');
        const toast = document.getElementById('toast');
        const cardViewBtn = document.getElementById('card-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const newPromptBtn = document.getElementById('new-prompt-btn');
        const modal = document.getElementById('modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const savePromptBtn = document.getElementById('save-prompt-btn');
        const promptTitleInput = document.getElementById('prompt-title-input');
        const promptCategoryInput = document.getElementById('prompt-category-input');
        const promptTagsInput = document.getElementById('prompt-tags-input');
        const promptTagsContainer = document.getElementById('prompt-tags-container');
        const promptContentInput = document.getElementById('prompt-content-input');
        const searchInput = document.getElementById('search-input');
        const sortOptions = document.getElementById('sort-options');
        const groupOptions = document.getElementById('group-options');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const categoryManager = document.getElementById('category-manager');
        const closeCategoryManager = document.querySelector('.close-category-manager');
        const categoryList = document.getElementById('category-list');
        const newCategoryInput = document.getElementById('new-category-input');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categorySidebarList = document.getElementById('category-sidebar-list');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        
        // 标签侧边栏相关元素
        const tagSidebarList = document.getElementById('tag-sidebar-list');
        const tagSearchInput = document.getElementById('tag-search-input');
        const clearTagSearch = document.getElementById('clear-tag-search');
        const manageTagsBtn = document.getElementById('manage-tags-btn');
        const tagsManager = document.getElementById('tags-manager');
        const closeTagsManager = document.querySelector('.close-tags-manager');
        const tagsManagerList = document.getElementById('tags-manager-list');
        const newTagInput = document.getElementById('new-tag-input');
        const addTagBtn = document.getElementById('add-tag-btn');
        const tagManagerSearch = document.getElementById('tag-manager-search');
        const clearTagManagerSearch = document.getElementById('clear-tag-manager-search');
        
        // 多选相关元素
        const selectModeBtn = document.getElementById('select-mode-btn');
        const bulkActions = document.getElementById('bulk-actions');
        const bulkCount = document.getElementById('bulk-count');
        const cancelSelectBtn = document.getElementById('cancel-select-btn');
        const bulkCategoryBtn = document.getElementById('bulk-category-btn');
        const bulkTagsBtn = document.getElementById('bulk-tags-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const multiActionModal = document.getElementById('multi-action-modal');
        const closeMultiActionModal = document.querySelector('.close-multi-action-modal');
        const bulkCategorySelect = document.getElementById('bulk-category-select');
        const applyBulkCategoryBtn = document.getElementById('apply-bulk-category-btn');
        
        // 标签相关元素
        const tagsModal = document.getElementById('tags-modal');
        const closeTagsModal = document.querySelector('.close-tags-modal');
        const bulkTagsInput = document.getElementById('bulk-tags-input');
        const bulkTagsContainer = document.getElementById('bulk-tags-container');
        const tagsActionMode = document.getElementById('tags-action-mode');
        const applyBulkTagsBtn = document.getElementById('apply-bulk-tags-btn');
        
        // 提示词存储
        let prompts = [];
        let categories = ['默认', '工作', '学习', '创意'];
        let currentView = 'card'; // 默认视图模式
        let editingIndex = -1; // 当前编辑的提示词索引，-1表示新建
        let currentFilter = 'all';
        let currentFilterType = 'category'; // 'category' or 'tag'
        let currentSort = 'newest';
        let currentGroup = 'none';
        let isSelectMode = false;
        let selectedPrompts = [];
        let allTags = new Set(); // 存储所有使用过的标签

        // 初始化：从本地存储加载数据
        function init() {
            const savedPrompts = localStorage.getItem('prompts');
            if (savedPrompts) {
                prompts = JSON.parse(savedPrompts);
                // 兼容旧数据，确保每个提示词都有tags字段
                prompts.forEach(prompt => {
                    if (!prompt.tags) {
                        prompt.tags = [];
                    }
                    // 收集所有标签
                    prompt.tags.forEach(tag => allTags.add(tag));
                });
            }
            
            const savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
            }
            
            const savedView = localStorage.getItem('viewMode');
            if (savedView) {
                currentView = savedView;
            }
            
            const savedFilter = localStorage.getItem('currentFilter');
            if (savedFilter) {
                currentFilter = savedFilter;
            }

            const savedFilterType = localStorage.getItem('currentFilterType');
            if (savedFilterType) {
                currentFilterType = savedFilterType;
            }
            
            const savedSort = localStorage.getItem('currentSort');
            if (savedSort) {
                currentSort = savedSort;
            }
            
            const savedGroup = localStorage.getItem('currentGroup');
            if (savedGroup) {
                currentGroup = savedGroup;
                groupOptions.value = currentGroup;
            }
            
            updateCategoryOptions();
            updateBulkCategoryOptions();
            updateSidebarCategories();
            updateSidebarTags();
            updateViewMode();
            applyFilterAndSort();
        }

        // 保存提示词到本地存储
        function savePrompts() {
            localStorage.setItem('prompts', JSON.stringify(prompts));
        }

        // 保存分类到本地存储
        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        // 保存视图模式到本地存储
        function saveViewMode() {
            localStorage.setItem('viewMode', currentView);
        }

        // 保存当前过滤器状态
        function saveFilterState() {
            localStorage.setItem('currentFilter', currentFilter);
            localStorage.setItem('currentFilterType', currentFilterType);
        }

        // 保存当前排序状态
        function saveSortState() {
            localStorage.setItem('currentSort', currentSort);
        }

        // 保存当前分组状态
        function saveGroupState() {
            localStorage.setItem('currentGroup', currentGroup);
        }

        // 更新分类选项
        function updateCategoryOptions() {
            promptCategoryInput.innerHTML = '<option value="">未分类</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                promptCategoryInput.appendChild(option);
            });
        }

        // 更新批量操作的分类选项
        function updateBulkCategoryOptions() {
            bulkCategorySelect.innerHTML = '<option value="">未分类</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                bulkCategorySelect.appendChild(option);
            });
        }

        // 计算每个分类的提示词数量
        function getCategoryCounts() {
            const counts = { '': 0 }; // 未分类的计数器
            categories.forEach(category => {
                counts[category] = 0;
            });
            
            prompts.forEach(prompt => {
                const category = prompt.category || '';
                if (counts[category] !== undefined) {
                    counts[category]++;
                }
            });
            
            return counts;
        }

        // 计算每个标签的提示词数量
        function getTagCounts() {
            const counts = {};
            
            prompts.forEach(prompt => {
                if (prompt.tags && prompt.tags.length > 0) {
                    prompt.tags.forEach(tag => {
                        if (!counts[tag]) {
                            counts[tag] = 0;
                        }
                        counts[tag]++;
                    });
                }
            });
            
            return counts;
        }

        // 更新左侧分类列表
        function updateSidebarCategories() {
            const categoryCounts = getCategoryCounts();
            let totalCount = prompts.length;
            
            // 保留第一个"所有分类"选项
            categorySidebarList.innerHTML = `
                <li class="sidebar-item" data-category="all" data-type="category">
                    <span>所有分类</span>
                    <span class="count">${totalCount}</span>
                </li>
            `;
            
            // 添加分类列表
            categories.forEach(category => {
                const categoryItem = document.createElement('li');
                categoryItem.className = 'sidebar-item';
                categoryItem.dataset.category = category;
                categoryItem.dataset.type = 'category';
                categoryItem.innerHTML = `
                    <span>${category}</span>
                    <span class="count">${categoryCounts[category] || 0}</span>
                `;
                categorySidebarList.appendChild(categoryItem);
            });
            
            // 添加"未分类"选项
            const uncategorizedItem = document.createElement('li');
            uncategorizedItem.className = 'sidebar-item';
            uncategorizedItem.dataset.category = '';
            uncategorizedItem.dataset.type = 'category';
            uncategorizedItem.innerHTML = `
                <span>未分类</span>
                <span class="count">${categoryCounts[''] || 0}</span>
            `;
            categorySidebarList.appendChild(uncategorizedItem);
            
            // 设置当前选中的项目
            document.querySelectorAll('.sidebar-item').forEach(item => {
                if (item.dataset.category === currentFilter && item.dataset.type === currentFilterType) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 添加点击事件
            categorySidebarList.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    currentFilter = this.dataset.category;
                    currentFilterType = this.dataset.type;
                    saveFilterState();
                    
                    // 更新选中状态
                    document.querySelectorAll('.sidebar-item, .tag-sidebar-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 应用过滤
                    applyFilterAndSort();
                    
                    // 在移动设备上点击分类后关闭侧边栏
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
        }

        // 更新左侧标签列表
        function updateSidebarTags() {
            const tagCounts = getTagCounts();
            const searchTerm = tagSearchInput.value.trim().toLowerCase();
            
            // 获取所有标签并按字母顺序排序
            let tags = Array.from(allTags).sort();
            
            // 应用搜索过滤
            if (searchTerm) {
                tags = tags.filter(tag => tag.toLowerCase().includes(searchTerm));
            }
            
            // 清空现有标签列表
            tagSidebarList.innerHTML = '';
            
            // 生成标签列表
            if (tags.length === 0) {
                tagSidebarList.innerHTML = '<li class="sidebar-item">无标签</li>';
            } else {
                tags.forEach(tag => {
                    const tagItem = document.createElement('li');
                    tagItem.className = 'tag-sidebar-item';
                    tagItem.dataset.category = tag;
                    tagItem.dataset.type = 'tag';
                    tagItem.innerHTML = `
                        <span class="tag-icon"></span>
                        <span class="tag-name">${tag}</span>
                        <span class="count">${tagCounts[tag] || 0}</span>
                    `;
                    tagSidebarList.appendChild(tagItem);
                });
            }
            
            // 设置当前选中的标签
            document.querySelectorAll('.tag-sidebar-item').forEach(item => {
                if (item.dataset.category === currentFilter && currentFilterType === 'tag') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
                
                // 添加点击事件
                item.addEventListener('click', function() {
                    currentFilter = this.dataset.category;
                    currentFilterType = 'tag';
                    saveFilterState();
                    
                    // 更新选中状态
                    document.querySelectorAll('.sidebar-item, .tag-sidebar-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 应用过滤
                    applyFilterAndSort();
                    
                    // 在移动设备上点击标签后关闭侧边栏
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
        }

        // 更新标签管理列表
        function updateTagsManagerList() {
            const searchTerm = tagManagerSearch.value.trim().toLowerCase();
            // 获取所有标签并按字母顺序排序
            let tags = Array.from(allTags).sort();
            const tagCounts = getTagCounts();
            
            // 应用搜索过滤
            if (searchTerm) {
                tags = tags.filter(tag => tag.toLowerCase().includes(searchTerm));
            }
            
            // 清空现有标签列表
            tagsManagerList.innerHTML = '';
            
            // 生成标签管理列表
            if (tags.length === 0) {
                tagsManagerList.innerHTML = '<div class="tag-manager-item">无标签</div>';
            } else {
                tags.forEach(tag => {
                    const tagItem = document.createElement('div');
                    tagItem.className = 'tag-manager-item';
                    tagItem.innerHTML = `
                        <span>
                            <span class="tag-dot"></span>
                            ${tag}
                            <span class="count">${tagCounts[tag] || 0}</span>
                        </span>
                        <button class="delete-btn" data-tag="${tag}">×</button>
                    `;
                    tagsManagerList.appendChild(tagItem);
                });
            }
            
            // 添加删除标签按钮事件
            tagsManagerList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tag = btn.dataset.tag;
                    deleteTag(tag);
                });
            });
        }

        // 应用过滤和排序
        function applyFilterAndSort() {
            let filteredPrompts = prompts;
            
            // 首先应用搜索过滤
            const searchQuery = searchInput.value.trim().toLowerCase();
            if (searchQuery) {
                filteredPrompts = filteredPrompts.filter(prompt => 
                    prompt.title.toLowerCase().includes(searchQuery) || 
                    prompt.content.toLowerCase().includes(searchQuery) || 
                    (prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                );
            }
            
            // 然后应用分类或标签过滤
            if (currentFilter !== 'all') {
                if (currentFilterType === 'category') {
                    filteredPrompts = filteredPrompts.filter(prompt => 
                        prompt.category === currentFilter);
                } else if (currentFilterType === 'tag') {
                    filteredPrompts = filteredPrompts.filter(prompt => 
                        prompt.tags && prompt.tags.includes(currentFilter));
                }
            }
            
            // 最后应用排序
            switch (currentSort) {
                case 'newest':
                    // 假设最新添加的在数组末尾
                    filteredPrompts = [...filteredPrompts].reverse();
                    break;
                case 'oldest':
                    // 不需要额外操作，原始顺序就是最早添加的在前
                    break;
                case 'alpha-asc':
                    filteredPrompts = [...filteredPrompts].sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'alpha-desc':
                    filteredPrompts = [...filteredPrompts].sort((a, b) => b.title.localeCompare(a.title));
                    break;
            }
            
            // 应用分组并渲染
            renderPromptsByGroup(filteredPrompts);
            
            // 更新侧边栏中的计数
            updateSidebarCategories();
            updateSidebarTags();
        }

        // 根据分组方式渲染提示词
        function renderPromptsByGroup(filteredPrompts) {
            promptContainer.innerHTML = '';
            
            if (currentGroup === 'none') {
                // 不分组，直接渲染所有提示词
                const promptGrid = document.createElement('div');
                promptGrid.className = currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                promptContainer.appendChild(promptGrid);
                
                renderPromptsToContainer(filteredPrompts, promptGrid);
            } else if (currentGroup === 'category') {
                // 按分类分组
                // 首先收集所有分类，包括未分类
                let groups = [''];
                filteredPrompts.forEach(prompt => {
                    if (prompt.category && !groups.includes(prompt.category)) {
                        groups.push(prompt.category);
                    }
                });
                
                // 按字母顺序排序分类，但保持"未分类"在最后
                const uncategorized = groups.shift(); // 移除空字符串（未分类）
                groups.sort();
                groups.push(uncategorized); // 将未分类添加到最后
                
                // 为每个分类创建组
                groups.forEach(group => {
                    const groupPrompts = filteredPrompts.filter(p => p.category === group);
                    if (groupPrompts.length > 0) {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'prompt-group';
                        
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header';
                        groupHeader.textContent = group || '未分类';
                        groupDiv.appendChild(groupHeader);
                        
                        const promptGrid = document.createElement('div');
                        promptGrid.className = currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                        groupDiv.appendChild(promptGrid);
                        
                        renderPromptsToContainer(groupPrompts, promptGrid);
                        
                        promptContainer.appendChild(groupDiv);
                    }
                });
            } else if (currentGroup === 'tags') {
                // 按标签分组
                
                // 首先，收集所有使用过的标签
                let usedTags = new Set();
                filteredPrompts.forEach(prompt => {
                    if (prompt.tags && prompt.tags.length > 0) {
                        prompt.tags.forEach(tag => usedTags.add(tag));
                    }
                });
                
                // 将标签转为数组并排序
                let tags = Array.from(usedTags).sort();
                
                // 添加"无标签"分组
                const noTagPrompts = filteredPrompts.filter(p => !p.tags || p.tags.length === 0);
                if (noTagPrompts.length > 0) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'prompt-group';
                    
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'group-header';
                    groupHeader.textContent = '无标签';
                    groupDiv.appendChild(groupHeader);
                    
                    const promptGrid = document.createElement('div');
                    promptGrid.className = currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                    groupDiv.appendChild(promptGrid);
                    
                    renderPromptsToContainer(noTagPrompts, promptGrid);
                    
                    promptContainer.appendChild(groupDiv);
                }
                
                // 为每个标签创建组
                tags.forEach(tag => {
                    const groupPrompts = filteredPrompts.filter(p => p.tags && p.tags.includes(tag));
                    if (groupPrompts.length > 0) {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'prompt-group';
                        
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header';
                        groupHeader.textContent = `标签: ${tag}`;
                        groupDiv.appendChild(groupHeader);
                        
                        const promptGrid = document.createElement('div');
                        promptGrid.className = currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                        groupDiv.appendChild(promptGrid);
                        
                        renderPromptsToContainer(groupPrompts, promptGrid);
                        
                        promptContainer.appendChild(groupDiv);
                    }
                });
            }
            
            // 如果已选择提示词，更新它们的选中状态
            if (isSelectMode && selectedPrompts.length > 0) {
                updateSelectedState();
            }
        }

        // 渲染提示词到指定容器
        function renderPromptsToContainer(promptsToRender, container) {
            promptsToRender.forEach((prompt, index) => {
                const originalIndex = prompts.findIndex(p => 
                    p.title === prompt.title && p.content === prompt.content);
                
                const promptCard = document.createElement('div');
                promptCard.className = 'prompt-card';
                promptCard.dataset.index = originalIndex;
                
                let categoryHtml = prompt.category 
                    ? `<div class="prompt-category">${prompt.category}</div>` 
                    : '';
                
                let tagsHtml = '';
                if (prompt.tags && prompt.tags.length > 0) {
                    tagsHtml = '<div class="prompt-tags">';
                    prompt.tags.forEach(tag => {
                        tagsHtml += `<span class="prompt-tag">${tag}</span>`;
                    });
                    tagsHtml += '</div>';
                }
                
                // 添加多选模式的复选框
                let checkboxHtml = isSelectMode ? 
                    `<div class="checkbox-container">
                        <input type="checkbox" class="prompt-checkbox" data-index="${originalIndex}">
                    </div>` : '';
                
                promptCard.innerHTML = `
                    ${checkboxHtml}
                    <div class="prompt-title">
                        <span>${prompt.title}</span>
                        <div class="card-actions">
                            <button class="edit-btn" data-index="${originalIndex}">✎</button>
                            <button class="delete-btn" data-index="${originalIndex}">×</button>
                        </div>
                    </div>
                    <div class="prompt-content">${prompt.content}</div>
                    ${categoryHtml}
                    ${tagsHtml}
                `;
                
                // 点击复制功能
                promptCard.addEventListener('click', (e) => {
                    // 如果处于多选模式，单击卡片选择/取消选择
                    if (isSelectMode) {
                        if (!e.target.classList.contains('edit-btn') && 
                            !e.target.classList.contains('delete-btn')) {
                            const checkbox = promptCard.querySelector('.prompt-checkbox');
                            checkbox.checked = !checkbox.checked;
                            togglePromptSelection(originalIndex, checkbox.checked);
                        }
                        return;
                    }
                    
                    // 如果点击的是删除或编辑按钮，不执行复制
                    if (e.target.classList.contains('delete-btn') || 
                        e.target.classList.contains('edit-btn')) {
                        return;
                    }
                    
                    // 复制到剪贴板
                    navigator.clipboard.writeText(prompt.content)
                        .then(() => showToast('已复制到剪贴板'))
                        .catch(err => showToast('复制失败: ' + err));
                });
                
                container.appendChild(promptCard);
            });
            
            // 添加复选框事件
            if (isSelectMode) {
                container.querySelectorAll('.prompt-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        togglePromptSelection(index, this.checked);
                    });
                });
            }
            
            // 添加删除按钮事件
            container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止冒泡，避免触发卡片的点击事件
                    const index = parseInt(btn.dataset.index);
                    deletePrompt(index);
                });
            });
            
            // 添加编辑按钮事件
            container.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止冒泡，避免触发卡片的点击事件
                    const index = parseInt(btn.dataset.index);
                    showModal(true, index);
                });
            });
        }

        // 删除提示词
        function deletePrompt(index) {
            if (confirm('确定要删除这个提示词吗？')) {
                // 从所有标签集合中移除该提示词的标签
                if (prompts[index].tags) {
                    prompts[index].tags.forEach(tag => {
                        // 检查其他提示词是否还在使用这个标签
                        const isTagUsedElsewhere = prompts.some((p, i) => 
                            i !== index && p.tags && p.tags.includes(tag)
                        );
                        
                        // 如果没有其他提示词使用这个标签，从allTags中移除
                        if (!isTagUsedElsewhere) {
                            allTags.delete(tag);
                        }
                    });
                }
                
                prompts.splice(index, 1);
                savePrompts();
                applyFilterAndSort();
                showToast('提示词已删除');
            }
        }

        // 从Markdown文件创建提示词
        function createPromptFromMarkdown(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                // 尝试提取标题（假设第一行是标题）
                const lines = content.split('\n');
                let title = file.name.replace('.md', '');
                
                // 如果第一行是Markdown标题格式，使用它
                if (lines[0].startsWith('# ')) {
                    title = lines[0].substring(2).trim();
                }
                
                // 添加新提示词（默认分类为空，标签为空数组）
                addPrompt(title, content, '', []);
                showToast('提示词已添加');
            };
            reader.readAsText(file);
        }

        // 添加提示词
        function addPrompt(title, content, category = '', tags = []) {
            prompts.push({ title, content, category, tags });
            
            // 添加新标签到全局标签集合
            if (tags && tags.length > 0) {
                tags.forEach(tag => allTags.add(tag));
            }
            
            savePrompts();
            applyFilterAndSort();
        }

        // 更新提示词
        function updatePrompt(index, title, content, category, tags) {
            // 从所有标签集合中移除该提示词的旧标签
            if (prompts[index].tags) {
                prompts[index].tags.forEach(tag => {
                    // 检查其他提示词是否还在使用这个标签
                    const isTagUsedElsewhere = prompts.some((p, i) => 
                        i !== index && p.tags && p.tags.includes(tag)
                    );
                    
                    // 如果没有其他提示词使用这个标签，从allTags中移除
                    if (!isTagUsedElsewhere) {
                        allTags.delete(tag);
                    }
                });
            }
            
            prompts[index] = { title, content, category, tags };
            
            // 添加新标签到全局标签集合
            if (tags && tags.length > 0) {
                tags.forEach(tag => allTags.add(tag));
            }
            
            savePrompts();
            applyFilterAndSort();
        }

        // 更新标签显示
        function updateTagsDisplay(tagsArray, container) {
            container.innerHTML = '';
            
            if (!tagsArray || tagsArray.length === 0) return;
            
            tagsArray.forEach(tag => {
                const tagItem = document.createElement('div');
                tagItem.className = 'tag-item';
                tagItem.innerHTML = `
                    <span class="tag-text">${tag}</span>
                    <span class="tag-remove" data-tag="${tag}">×</span>
                `;
                container.appendChild(tagItem);
            });
            
            // 添加删除标签事件
            container.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tag = btn.dataset.tag;
                    
                    // 从输入框的当前标签中移除
                    let inputField;
                    if (container === promptTagsContainer) {
                        inputField = promptTagsInput;
                    } else if (container === bulkTagsContainer) {
                        inputField = bulkTagsInput;
                    }
                    
                    if (inputField) {
                        const currentTags = inputField.value.split(',')
                            .map(t => t.trim())
                            .filter(t => t && t !== tag);
                        inputField.value = currentTags.join(', ');
                        
                        // 更新标签显示
                        if (container === promptTagsContainer) {
                            updateTagsDisplay(currentTags, promptTagsContainer);
                        } else if (container === bulkTagsContainer) {
                            updateTagsDisplay(currentTags, bulkTagsContainer);
                        }
                    }
                });
            });
        }

        // 处理输入的标签字符串，返回标签数组
        function parseTagsInput(input) {
            if (!input) return [];
            
            return input.split(',')
                .map(tag => tag.trim())
                .filter(tag => tag)
                .filter((tag, index, self) => self.indexOf(tag) === index); // 去重
        }

        // 显示提示信息
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // 更新视图模式
        function updateViewMode() {
            if (currentView === 'list') {
                listViewBtn.style.backgroundColor = 'var(--secondary-color)';
                cardViewBtn.style.backgroundColor = 'var(--primary-color)';
            } else {
                cardViewBtn.style.backgroundColor = 'var(--secondary-color)';
                listViewBtn.style.backgroundColor = 'var(--primary-color)';
            }
            applyFilterAndSort();
        }

        // 显示模态框
        function showModal(isEditing = false, index = -1) {
            editingIndex = index;
            
            if (isEditing) {
                document.getElementById('modal-title').textContent = '编辑提示词';
                promptTitleInput.value = prompts[index].title;
                promptContentInput.value = prompts[index].content;
                promptCategoryInput.value = prompts[index].category || '';
                
                // 设置标签
                const tags = prompts[index].tags || [];
                promptTagsInput.value = tags.join(', ');
                updateTagsDisplay(tags, promptTagsContainer);
            } else {
                document.getElementById('modal-title').textContent = '新建提示词';
                promptTitleInput.value = '';
                promptContentInput.value = '';
                promptCategoryInput.value = '';
                promptTagsInput.value = '';
                promptTagsContainer.innerHTML = '';
            }
            
            modal.style.display = 'flex';
        }

        // 渲染分类管理列表
        function renderCategoryList() {
            const categoryCounts = getCategoryCounts();
            categoryList.innerHTML = '';
            
            categories.forEach((category, index) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <span>${category} <span class="count">${categoryCounts[category] || 0}</span></span>
                    <button class="delete-btn" data-index="${index}">×</button>
                `;
                categoryList.appendChild(categoryItem);
            });
            
            // 添加删除分类按钮事件
            categoryList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    deleteCategory(index);
                });
            });
        }

        // 添加新分类
        function addCategory(categoryName) {
            if (!categoryName) return;
            
            if (categories.includes(categoryName)) {
                showToast('该分类已存在');
                return;
            }
            
            categories.push(categoryName);
            saveCategories();
            updateCategoryOptions();
            updateBulkCategoryOptions();
            updateSidebarCategories();
            renderCategoryList();
            showToast('分类已添加');
        }

        // 删除分类
        function deleteCategory(index) {
            const categoryToDelete = categories[index];
            
            if (confirm(`确定要删除"${categoryToDelete}"分类吗？这不会删除该分类下的提示词，但它们将变为未分类状态。`)) {
                // 将该分类下的所有提示词设为未分类
                prompts.forEach(prompt => {
                    if (prompt.category === categoryToDelete) {
                        prompt.category = '';
                    }
                });
                
                categories.splice(index, 1);
                saveCategories();
                savePrompts();
                updateCategoryOptions();
                updateBulkCategoryOptions();
                updateSidebarCategories();
                renderCategoryList();
                
                // 如果当前过滤器是被删除的分类，切换到"所有分类"
                if (currentFilter === categoryToDelete && currentFilterType === 'category') {
                    currentFilter = 'all';
                    currentFilterType = 'category';
                    saveFilterState();
                }
                
                applyFilterAndSort();
                showToast('分类已删除');
            }
        }

        // 添加新标签
        function addTag(tagName) {
            if (!tagName) return;
            
            if (allTags.has(tagName)) {
                showToast('该标签已存在');
                return;
            }
            
            allTags.add(tagName);
            updateSidebarTags();
            updateTagsManagerList();
            showToast('标签已添加');
        }

        // 删除标签
        function deleteTag(tagName) {
            if (confirm(`确定要删除"${tagName}"标签吗？这将从所有使用该标签的提示词中移除它。`)) {
                // 从所有提示词中移除该标签
                prompts.forEach(prompt => {
                    if (prompt.tags && prompt.tags.includes(tagName)) {
                        prompt.tags = prompt.tags.filter(tag => tag !== tagName);
                    }
                });
                
                // 从全局标签集合中移除
                allTags.delete(tagName);
                
                savePrompts();
                updateSidebarTags();
                updateTagsManagerList();
                
                // 如果当前过滤器是被删除的标签，切换到"所有分类"
                if (currentFilter === tagName && currentFilterType === 'tag') {
                    currentFilter = 'all';
                    currentFilterType = 'category';
                    saveFilterState();
                }
                
                applyFilterAndSort();
                showToast('标签已删除');
            }
        }

        // 切换多选模式
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            selectedPrompts = [];
            
            if (isSelectMode) {
                selectModeBtn.textContent = '退出多选';
                selectModeBtn.style.backgroundColor = 'var(--secondary-color)';
                bulkCount.textContent = '0';
                bulkActions.classList.add('active');
            } else {
                selectModeBtn.textContent = '多选模式';
                selectModeBtn.style.backgroundColor = 'var(--primary-color)';
                bulkActions.classList.remove('active');
            }
            
            applyFilterAndSort();
        }

        // 切换提示词选中状态
        function togglePromptSelection(index, isSelected) {
            const card = document.querySelector(`.prompt-card[data-index="${index}"]`);
            
            if (isSelected) {
                if (!selectedPrompts.includes(index)) {
                    selectedPrompts.push(index);
                }
                if (card) card.classList.add('selected');
            } else {
                selectedPrompts = selectedPrompts.filter(i => i !== index);
                if (card) card.classList.remove('selected');
            }
            
            // 更新选中计数
            bulkCount.textContent = selectedPrompts.length;
        }

        // 更新选中状态（用于重新渲染后恢复选中状态）
        function updateSelectedState() {
            selectedPrompts.forEach(index => {
                const checkbox = document.querySelector(`.prompt-checkbox[data-index="${index}"]`);
                const card = document.querySelector(`.prompt-card[data-index="${index}"]`);
                
                if (checkbox) checkbox.checked = true;
                if (card) card.classList.add('selected');
            });
            
            bulkCount.textContent = selectedPrompts.length;
        }

        // 批量删除提示词
        function bulkDeletePrompts() {
            if (selectedPrompts.length === 0) {
                showToast('请先选择要删除的提示词');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedPrompts.length} 个提示词吗？`)) {
                // 按照索引从大到小排序，以避免删除时索引变化的问题
                selectedPrompts.sort((a, b) => b - a);
                
                // 从所有标签集合中移除将被删除的标签
                selectedPrompts.forEach(index => {
                    if (prompts[index] && prompts[index].tags) {
                        prompts[index].tags.forEach(tag => {
                            // 检查其他未被删除的提示词是否还在使用这个标签
                            const isTagUsedElsewhere = prompts.some((p, i) => 
                                !selectedPrompts.includes(i) && p.tags && p.tags.includes(tag)
                            );
                            
                            if (!isTagUsedElsewhere) {
                                allTags.delete(tag);
                            }
                        });
                    }
                });
                
                selectedPrompts.forEach(index => {
                    prompts.splice(index, 1);
                });
                
                savePrompts();
                selectedPrompts = [];
                bulkCount.textContent = '0';
                
                applyFilterAndSort();
                showToast('已删除选中的提示词');
            }
        }

        // 批量设置分类
        function showBulkCategoryModal() {
            if (selectedPrompts.length === 0) {
                showToast('请先选择要设置分类的提示词');
                return;
            }
            
            multiActionModal.style.display = 'flex';
        }

        // 批量设置标签
        function showBulkTagsModal() {
            if (selectedPrompts.length === 0) {
                showToast('请先选择要设置标签的提示词');
                return;
            }
            
            // 清空标签输入和容器
            bulkTagsInput.value = '';
            bulkTagsContainer.innerHTML = '';
            
            tagsModal.style.display = 'flex';
        }

        // 应用批量分类设置
        function applyBulkCategory() {
            const category = bulkCategorySelect.value;
            const countBefore = selectedPrompts.length;
            
            // 更新所有选中提示词的分类
            selectedPrompts.forEach(index => {
                if (index < prompts.length) { // 确保索引有效
                    prompts[index].category = category;
                }
            });
            
            savePrompts();
            multiActionModal.style.display = 'none';
            
            // 如果当前是按分类过滤，并且设置了不同的分类，一些提示词可能会从视图中消失
            if (currentFilterType === 'category' && currentFilter !== 'all' && currentFilter !== category) {
                selectedPrompts = [];
                bulkCount.textContent = '0';
                showToast(`已将 ${countBefore} 个提示词移至"${category || '未分类'}"分类`);
            } else {
                showToast(`已将 ${countBefore} 个提示词设为"${category || '未分类'}"分类`);
            }
            
            applyFilterAndSort();
        }

        // 应用批量标签设置
        function applyBulkTags() {
            const tagsInput = bulkTagsInput.value;
            const newTags = parseTagsInput(tagsInput);
            const mode = tagsActionMode.value;
            const countBefore = selectedPrompts.length;
            
            // 更新所有选中提示词的标签
            selectedPrompts.forEach(index => {
                if (index < prompts.length) { // 确保索引有效
                    let currentTags = prompts[index].tags || [];
                    
                    if (mode === 'replace') {
                        // 替换模式：用新标签完全替换旧标签
                        prompts[index].tags = [...newTags];
                    } else if (mode === 'add') {
                        // 添加模式：将新标签添加到现有标签（避免重复）
                        const combinedTags = [...currentTags, ...newTags];
                        prompts[index].tags = combinedTags.filter((tag, i, self) => self.indexOf(tag) === i);
                    } else if (mode === 'remove') {
                        // 移除模式：从现有标签中移除指定的标签
                        prompts[index].tags = currentTags.filter(tag => !newTags.includes(tag));
                    }
                }
            });
            
            // 更新全局标签集合
            updateGlobalTags();
            
            savePrompts();
            tagsModal.style.display = 'none';
            
            let actionMsg;
            switch (mode) {
                case 'replace':
                    actionMsg = '替换了';
                    break;
                case 'add':
                    actionMsg = '添加了';
                    break;
                case 'remove':
                    actionMsg = '移除了';
                    break;
            }
            
            showToast(`已为 ${countBefore} 个提示词${actionMsg}标签`);
            applyFilterAndSort();
        }

        // 更新全局标签集合
        function updateGlobalTags() {
            allTags.clear();
            prompts.forEach(prompt => {
                if (prompt.tags && prompt.tags.length > 0) {
                    prompt.tags.forEach(tag => allTags.add(tag));
                }
            });
        }

        // 事件监听器
        
        // 标签输入事件
        promptTagsInput.addEventListener('input', function() {
            const tags = parseTagsInput(this.value);
            updateTagsDisplay(tags, promptTagsContainer);
        });

        bulkTagsInput.addEventListener('input', function() {
            const tags = parseTagsInput(this.value);
            updateTagsDisplay(tags, bulkTagsContainer);
        });
        
        // 标签搜索事件
        tagSearchInput.addEventListener('input', updateSidebarTags);
        clearTagSearch.addEventListener('click', () => {
            tagSearchInput.value = '';
            updateSidebarTags();
        });
        
        tagManagerSearch.addEventListener('input', updateTagsManagerList);
        clearTagManagerSearch.addEventListener('click', () => {
            tagManagerSearch.value = '';
            updateTagsManagerList();
        });
        
        // 拖放区域事件
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.endsWith('.md')) {
                    createPromptFromMarkdown(files[i]);
                }
            }
        }

        // 文件选择按钮
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    if (fileInput.files[i].name.endsWith('.md')) {
                        createPromptFromMarkdown(fileInput.files[i]);
                    }
                }
                fileInput.value = ''; // 重置文件输入
            }
        });

        // 视图切换按钮
        cardViewBtn.addEventListener('click', () => {
            currentView = 'card';
            saveViewMode();
            updateViewMode();
        });

        listViewBtn.addEventListener('click', () => {
            currentView = 'list';
            saveViewMode();
            updateViewMode();
        });

        // 排序选项变化
        sortOptions.addEventListener('change', () => {
            currentSort = sortOptions.value;
            saveSortState();
            applyFilterAndSort();
        });

        // 分组选项变化
        groupOptions.addEventListener('change', () => {
            currentGroup = groupOptions.value;
            saveGroupState();
            applyFilterAndSort();
        });

        // 新建提示词按钮
        newPromptBtn.addEventListener('click', () => {
            showModal();
        });

        // 管理分类按钮
        manageCategoriesBtn.addEventListener('click', () => {
            renderCategoryList();
            categoryManager.style.display = 'flex';
        });

        // 管理标签按钮
        manageTagsBtn.addEventListener('click', () => {
            updateTagsManagerList();
            tagsManager.style.display = 'flex';
        });

        // 关闭分类管理器
        closeCategoryManager.addEventListener('click', () => {
            categoryManager.style.display = 'none';
        });

        // 关闭标签管理器
        closeTagsManager.addEventListener('click', () => {
            tagsManager.style.display = 'none';
        });

        // 添加分类按钮
        addCategoryBtn.addEventListener('click', () => {
            const newCategory = newCategoryInput.value.trim();
            if (newCategory) {
                addCategory(newCategory);
                newCategoryInput.value = '';
            }
        });

        // 添加标签按钮
        addTagBtn.addEventListener('click', () => {
            const newTag = newTagInput.value.trim();
            if (newTag) {
                addTag(newTag);
                newTagInput.value = '';
            }
        });

        // 新分类输入框回车事件
        newCategoryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const newCategory = newCategoryInput.value.trim();
                if (newCategory) {
                    addCategory(newCategory);
                    newCategoryInput.value = '';
                }
            }
        });

        // 新标签输入框回车事件
        newTagInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const newTag = newTagInput.value.trim();
                if (newTag) {
                    addTag(newTag);
                    newTagInput.value = '';
                }
            }
        });

        // 关闭模态框
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // 关闭批量操作模态框
        closeMultiActionModal.addEventListener('click', () => {
            multiActionModal.style.display = 'none';
        });

        // 关闭标签管理模态框
        closeTagsModal.addEventListener('click', () => {
            tagsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
            if (e.target === categoryManager) {
                categoryManager.style.display = 'none';
            }
            if (e.target === multiActionModal) {
                multiActionModal.style.display = 'none';
            }
            if (e.target === tagsModal) {
                tagsModal.style.display = 'none';
            }
            if (e.target === tagsManager) {
                tagsManager.style.display = 'none';
            }
        });

        // 保存提示词
        savePromptBtn.addEventListener('click', () => {
            const title = promptTitleInput.value.trim();
            const content = promptContentInput.value.trim();
            const category = promptCategoryInput.value;
            const tags = parseTagsInput(promptTagsInput.value);
            
            if (!title || !content) {
                showToast('标题和内容不能为空');
                return;
            }
            
            if (editingIndex >= 0) {
                updatePrompt(editingIndex, title, content, category, tags);
                showToast('提示词已更新');
            } else {
                addPrompt(title, content, category, tags);
                showToast('提示词已添加');
            }
            
            modal.style.display = 'none';
        });

        // 搜索输入
        searchInput.addEventListener('input', () => {
            applyFilterAndSort();
        });

        // 多选模式相关事件
        selectModeBtn.addEventListener('click', toggleSelectMode);
        cancelSelectBtn.addEventListener('click', toggleSelectMode);
        bulkDeleteBtn.addEventListener('click', bulkDeletePrompts);
        bulkCategoryBtn.addEventListener('click', showBulkCategoryModal);
        bulkTagsBtn.addEventListener('click', showBulkTagsModal);
        applyBulkCategoryBtn.addEventListener('click', applyBulkCategory);
        applyBulkTagsBtn.addEventListener('click', applyBulkTags);

        // 移动设备菜单切换
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // 窗口调整大小时处理侧边栏
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
        });

        // 初始化应用
        init();
    </script>
</body>
</html>
