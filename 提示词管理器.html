<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理器</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6789b8;
            --bg-color: #f5f7fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --tag-color: #e1f5fe;
            --tag-text: #0277bd;
            --sidebar-width: 220px;
            --sidebar-bg: #f0f4f8;
            --select-color: rgba(74, 111, 165, 0.15);
            --group-header-bg: #ebf2fa;
            --group-border: #d1e1f5;
            --tag-bg: #edf7ff;
            --tag-primary: #4a90e2;
            --count-bg: #e3e9f2;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --tab-height: 50px;
            --tab-bg: #e9eff8;
            --tab-active-bg: #fff;
            --tab-active-border: #4a6fa5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        /* 标签样式 */
        .tabs-container {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            height: var(--tab-height);
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            position: relative;
        }

        .tab.active {
            background-color: var(--tab-active-bg);
            border-top: 3px solid var(--tab-active-border);
        }

        .tab-add {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            cursor: pointer;
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .tab-delete {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            cursor: pointer;
            font-size: 20px;
            color: #f44336;
        }

        .tab-delete:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        .main-container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            padding: 20px 15px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar h2 button {
            font-size: 12px;
            padding: 3px 6px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-list {
            list-style: none;
        }

        .sidebar-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-item:hover {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .sidebar-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .sidebar-item.active .count {
            background-color: white;
            color: var(--primary-color);
        }

        .tag-sidebar-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tag-sidebar-item:hover {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .tag-sidebar-item.active {
            background-color: var(--tag-bg);
            color: var(--tag-primary);
            border-left: 3px solid var(--tag-primary);
        }

        .tag-sidebar-item .tag-icon {
            width: 8px;
            height: 8px;
            background-color: var(--tag-primary);
            border-radius: 50%;
            margin-right: 8px;
        }

        .tag-sidebar-item .tag-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .count {
            background-color: var(--count-bg);
            color: var(--text-color);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 25px;
            text-align: center;
        }

        .sidebar-search {
            margin-bottom: 10px;
            position: relative;
        }

        .sidebar-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .sidebar-search .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 14px;
            display: none;
        }

        .sidebar-search input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-right: 15px;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            width: 100%;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 13px;
        }

        .btn-menu {
            background-color: #5a7db5;
        }

        select, input[type="text"], input[type="password"], input[type="url"] {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            font-size: 14px;
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        #sort-options, #group-options {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            font-size: 14px;
        }

        #drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            background-color: var(--card-color);
            cursor: pointer;
            transition: border-color 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #drop-area:hover {
            border-color: var(--primary-color);
        }

        #drop-area.highlight {
            border-color: var(--primary-color);
            background-color: rgba(74, 111, 165, 0.1);
        }

        #drop-area p {
            margin: 0;
            font-size: 14px;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
            flex: 1;
            min-width: 200px;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        #search-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .group-header {
            background-color: var(--group-header-bg);
            padding: 10px 15px;
            border-radius: 5px;
            margin: 25px 0 15px 0;
            font-weight: bold;
            color: var(--primary-color);
            border-left: 5px solid var(--group-border);
        }

        .group-header:first-child {
            margin-top: 0;
        }

        .prompt-group {
            margin-bottom: 15px;
        }

        .prompt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .prompt-card {
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .prompt-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .prompt-card.selected {
            background-color: var(--select-color);
            border: 2px solid var(--primary-color);
        }

        .prompt-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-content {
            white-space: pre-wrap;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .prompt-category {
            display: inline-block;
            background-color: var(--tag-color);
            color: var(--tag-text);
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 10px;
            margin-right: 5px;
        }

        .prompt-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .prompt-tag {
            display: inline-block;
            background-color: var(--tag-bg);
            color: var(--tag-primary);
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid var(--tag-primary);
        }

        .tag-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            background-color: var(--tag-bg);
            border: 1px solid var(--tag-primary);
            border-radius: 12px;
            padding: 3px 5px 3px 8px;
        }

        .tag-text {
            color: var(--tag-primary);
            font-size: 12px;
            margin-right: 5px;
        }

        .tag-remove {
            width: 16px;
            height: 16px;
            background-color: var(--tag-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        .list-view .prompt-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list-view .prompt-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }

        .list-view .prompt-title {
            margin-bottom: 0;
            flex: 1;
        }

        .list-view .prompt-content {
            display: none;
        }

        .list-view .prompt-category, .list-view .prompt-tags {
            margin-left: 10px;
            margin-top: 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .edit-btn {
            background-color: #ffc107;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background-color: #ffa000;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
        }

        #modal, #category-manager, #multi-action-modal, #tags-modal, #tags-manager, #backup-modal, #restore-modal, #tab-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group small {
            display: block;
            color: #666;
            margin-top: 4px;
            font-size: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .category-content, .tags-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .category-list, .tags-list {
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-item, .tag-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-color);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .tag-manager-item span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tag-manager-item .tag-dot {
            width: 8px;
            height: 8px;
            background-color: var(--tag-primary);
            border-radius: 50%;
        }

        .add-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-form input {
            flex: 1;
            padding: 8px 12px;
        }

        .tags-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .tags-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .bulk-actions {
            display: none;
            background-color: var(--primary-color);
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: space-between;
            color: white;
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bulk-count {
            font-weight: bold;
        }

        .bulk-actions-right {
            display: flex;
            gap: 10px;
        }

        .bulk-action-btn {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .bulk-action-btn:hover {
            background-color: #f0f0f0;
        }

        .bulk-action-btn.danger {
            background-color: #f44336;
            color: white;
        }

        .bulk-action-btn.danger:hover {
            background-color: #d32f2f;
        }

        .checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
        }

        .prompt-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .backup-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .backup-option {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .backup-option:hover {
            background-color: var(--card-color);
            border-color: var(--primary-color);
        }

        .backup-option h3 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .backup-option p {
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
        }

        .file-input-label {
            display: inline-block;
            padding: 6px 12px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-input-label:hover {
            background-color: var(--secondary-color);
        }

        .status-message {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-color);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 5px;
            z-index: 100;
            right: 0;
        }

        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-color);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: var(--tab-height);
                height: calc(100% - var(--tab-height));
                z-index: 900;
                transition: left 0.3s;
                width: 80%;
                max-width: 300px;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .prompt-grid {
                grid-template-columns: 1fr;
            }
            
            #drop-area {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 10px;
            }

            .bulk-actions-right {
                width: 100%;
                justify-content: space-between;
            }

            .backup-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 标签栏 -->
    <div class="tabs-container" id="tabs-container">
        <div class="tab active" data-tab="prompts">提示词管理器</div>
        <div class="tab" data-tab="macros">宏管理器</div>
        <div class="tab-add" id="tab-add">+</div>
    </div>

    <div class="main-container">
        <!-- 左侧分类栏 -->
        <div class="sidebar" id="sidebar">
            <!-- 分类部分 -->
            <div class="sidebar-section">
                <h2>
                    分类
                    <button id="manage-categories-btn">管理</button>
                </h2>
                <ul class="sidebar-list" id="category-sidebar-list">
                    <li class="sidebar-item active" data-category="all">
                        <span>所有分类</span>
                        <span class="count">0</span>
                    </li>
                    <!-- 分类会通过JavaScript动态添加 -->
                </ul>
            </div>

            <!-- 标签部分 -->
            <div class="sidebar-section">
                <h2>
                    标签
                    <button id="manage-tags-btn">管理</button>
                </h2>
                <div class="sidebar-search">
                    <input type="text" id="tag-search-input" placeholder="搜索标签...">
                    <span class="clear-search" id="clear-tag-search">&times;</span>
                </div>
                <ul class="sidebar-list" id="tag-sidebar-list">
                    <!-- 标签会通过JavaScript动态添加 -->
                </ul>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <header>
                <h1 id="current-tab-title">提示词管理器</h1>
                <div class="dropdown">
                    <button id="menu-btn" class="btn-menu">菜单 ▾</button>
                    <div class="dropdown-content">
                        <a id="backup-menu-btn">备份</a>
                        <a id="restore-menu-btn">恢复</a>
                    </div>
                </div>
            </header>

            <!-- 批量操作工具栏 -->
            <div class="bulk-actions" id="bulk-actions">
                <div class="bulk-actions-left">
                    <span>已选择 <span class="bulk-count" id="bulk-count">0</span> 个项目</span>
                    <button class="bulk-action-btn" id="cancel-select-btn">取消选择</button>
                </div>
                <div class="bulk-actions-right">
                    <button class="bulk-action-btn" id="bulk-category-btn">设置分类</button>
                    <button class="bulk-action-btn" id="bulk-tags-btn">设置标签</button>
                    <button class="bulk-action-btn danger" id="bulk-delete-btn">批量删除</button>
                </div>
            </div>

            <div class="controls-row">
                <div class="control-group">
                    <button id="new-item-btn">新建项目</button>
                    <button id="select-mode-btn" class="btn-small">多选模式</button>
                    <select id="sort-options">
                        <option value="newest">最新添加</option>
                        <option value="oldest">最早添加</option>
                        <option value="alpha-asc">标题 A-Z</option>
                        <option value="alpha-desc">标题 Z-A</option>
                    </select>
                </div>

                <div id="drop-area">
                    <p>拖放Markdown文件到这里</p>
                    <button id="file-select-btn" class="btn-small">选择文件</button>
                    <input type="file" id="file-input" accept=".md" style="display: none;">
                </div>

                <div class="control-group">
                    <select id="group-options">
                        <option value="none">不分组</option>
                        <option value="category">按分类分组</option>
                        <option value="tags">按标签分组</option>
                    </select>
                    <button id="card-view-btn" class="btn-small">卡片视图</button>
                    <button id="list-view-btn" class="btn-small">列表视图</button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="search-input" placeholder="搜索...">
            </div>

            <div id="prompt-container"></div>
        </div>
    </div>

    <!-- 移动设备菜单按钮 -->
    <div class="menu-toggle" id="menu-toggle">☰</div>

    <div class="toast" id="toast">已复制到剪贴板</div>

    <!-- 创建/编辑项目模态框 -->
    <div id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">新建项目</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="prompt-title-input">标题</label>
                <input type="text" id="prompt-title-input" placeholder="输入标题">
            </div>
            <div class="form-group">
                <label for="prompt-category-input">分类</label>
                <select id="prompt-category-input">
                    <option value="">未分类</option>
                </select>
            </div>
            <div class="form-group">
                <label for="prompt-tags-input">标签 (多个标签用逗号分隔)</label>
                <input type="text" id="prompt-tags-input" placeholder="输入标签，如: 工作,翻译,AI">
                <div class="tag-container" id="prompt-tags-container"></div>
            </div>
            <div class="form-group">
                <label for="prompt-content-input">内容</label>
                <textarea id="prompt-content-input" placeholder="输入内容"></textarea>
            </div>
            <button id="save-prompt-btn">保存</button>
        </div>
    </div>

    <!-- 分类管理模态框 -->
    <div id="category-manager">
        <div class="category-content">
            <div class="modal-header">
                <h2>管理分类</h2>
                <button class="close-category-manager">&times;</button>
            </div>
            <div class="category-list" id="category-list"></div>
            <div class="add-form">
                <input type="text" id="new-category-input" placeholder="新分类名称">
                <button id="add-category-btn">添加</button>
            </div>
        </div>
    </div>

    <!-- 标签管理模态框 -->
    <div id="tags-manager">
        <div class="tags-content">
            <div class="modal-header">
                <h2>管理标签</h2>
                <button class="close-tags-manager">&times;</button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="tag-manager-search" placeholder="搜索标签...">
                <span class="clear-search" id="clear-tag-manager-search">&times;</span>
            </div>
            <div class="tags-list" id="tags-manager-list"></div>
            <div class="add-form">
                <input type="text" id="new-tag-input" placeholder="新标签名称">
                <button id="add-tag-btn">添加</button>
            </div>
        </div>
    </div>

    <!-- 批量分类设置模态框 -->
    <div id="multi-action-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置分类</h2>
                <button class="close-multi-action-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="bulk-category-select">选择分类</label>
                <select id="bulk-category-select">
                    <option value="">未分类</option>
                </select>
            </div>
            <button id="apply-bulk-category-btn">应用</button>
        </div>
    </div>

    <!-- 批量标签设置模态框 -->
    <div id="tags-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置标签</h2>
                <button class="close-tags-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="bulk-tags-input">输入标签 (多个标签用逗号分隔)</label>
                <input type="text" id="bulk-tags-input" placeholder="输入标签，如: 工作,翻译,AI">
                <div class="tag-container" id="bulk-tags-container"></div>
            </div>
            <div class="form-group">
                <label>操作方式</label>
                <select id="tags-action-mode">
                    <option value="replace">替换所有标签</option>
                    <option value="add">添加标签</option>
                    <option value="remove">移除标签</option>
                </select>
            </div>
            <button id="apply-bulk-tags-btn">应用</button>
        </div>
    </div>

    <!-- 备份模态框 -->
    <div id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>备份数据</h2>
                <button class="close-backup-modal">&times;</button>
            </div>
            <div class="backup-option">
                <h3>本地备份</h3>
                <p>将所有页签的数据保存到你的设备</p>
                <div class="backup-buttons">
                    <button id="local-backup-btn">下载备份文件</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 恢复模态框 -->
    <div id="restore-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>恢复数据</h2>
                <button class="close-restore-modal">&times;</button>
            </div>
            <div class="backup-option">
                <h3>从本地文件恢复</h3>
                <p>从你的设备上的备份文件恢复所有页签的数据</p>
                <div class="backup-buttons">
                    <label for="restore-file-input" class="file-input-label">选择备份文件</label>
                    <input type="file" id="restore-file-input" accept=".json" style="display:none">
                </div>
                <div class="status-message" id="local-restore-status"></div>
            </div>
        </div>
    </div>

    <!-- 新增标签页模态框 -->
    <div id="tab-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加新页签</h2>
                <button class="close-tab-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="new-tab-name">页签名称</label>
                <input type="text" id="new-tab-name" placeholder="输入新页签名称，如：地址管理器">
            </div>
            <button id="add-tab-btn">添加</button>
        </div>
    </div>

    <script>
        // 多页签系统和数据管理
        const tabSystem = {
            tabs: ['prompts', 'macros'], // 默认标签页
            tabNames: {
                'prompts': '提示词管理器',
                'macros': '宏管理器'
            },
            currentTab: 'prompts',
            data: {}, // 存储各标签页的数据

            init() {
                // 初始化各标签页的数据结构
                this.tabs.forEach(tab => {
                    if (!this.data[tab]) {
                        this.data[tab] = {
                            items: [],
                            categories: ['默认', '工作', '学习', '创意'],
                            allTags: new Set()
                        };
                    }
                });

                // 从本地存储加载标签页配置
                const savedTabs = utils.storage.load('tabs');
                if (savedTabs) {
                    this.tabs = savedTabs.tabs || this.tabs;
                    this.tabNames = savedTabs.tabNames || this.tabNames;
                }

                // 为每个标签页加载数据
                this.tabs.forEach(tab => {
                    const savedItems = utils.storage.load(`${tab}_items`);
                    if (savedItems) {
                        this.data[tab].items = savedItems;
                        
                        // 更新标签集合
                        this.data[tab].items.forEach(item => {
                            if (!item.tags) item.tags = [];
                            item.tags.forEach(tag => this.data[tab].allTags.add(tag));
                        });
                    }

                    const savedCategories = utils.storage.load(`${tab}_categories`);
                    if (savedCategories) {
                        this.data[tab].categories = savedCategories;
                    }
                });

                // 渲染标签页
                this.renderTabs();
            },

            renderTabs() {
                const tabsContainer = document.getElementById('tabs-container');
                let tabsHTML = '';
                
                this.tabs.forEach(tab => {
                    const isActive = tab === this.currentTab ? 'active' : '';
                    tabsHTML += `<div class="tab ${isActive}" data-tab="${tab}">${this.tabNames[tab]}</div>`;
                });
                
                tabsHTML += '<div class="tab-add" id="tab-add">+</div>';
                
                // 如果当前标签不是默认标签，则添加删除按钮
                const canDelete = this.currentTab !== 'prompts' && this.currentTab !== 'macros';
                if (canDelete) {
                    tabsHTML += `<div class="tab-delete" id="tab-delete">×</div>`;
                }
                
                tabsContainer.innerHTML = tabsHTML;
                
                // 添加标签点击事件
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });
                
                // 添加新标签按钮事件
                document.getElementById('tab-add').addEventListener('click', this.showAddTabModal);
                
                // 添加删除当前标签事件
                const tabDelete = document.getElementById('tab-delete');
                if (tabDelete) {
                    tabDelete.addEventListener('click', () => {
                        this.removeTab(this.currentTab);
                    });
                }
                
                // 更新当前标签页标题
                document.getElementById('current-tab-title').textContent = this.tabNames[this.currentTab];
            },

            switchTab(tabId) {
                if (tabId === this.currentTab) return;
                
                // 保存当前标签页状态
                state.saveTabState();
                
                // 切换到新标签页
                this.currentTab = tabId;
                
                // 从存储中加载新标签页的状态
                const savedState = utils.storage.load(`${tabId}_state`);
                if (savedState) {
                    state.currentView = savedState.view || 'card';
                    state.currentFilter = savedState.filter || 'all';
                    state.currentFilterType = savedState.filterType || 'category';
                    state.currentSort = savedState.sort || 'newest';
                    state.currentGroup = savedState.group || 'none';
                    els.sortOptions.value = state.currentSort;
                    els.groupOptions.value = state.currentGroup;
                }
                
                // 更新UI
                this.renderTabs();
                
                document.getElementById('current-tab-title').textContent = this.tabNames[tabId];
                
                // 清空搜索和选择
                els.searchInput.value = '';
                state.isSelectMode = false;
                state.selectedPrompts = [];
                els.bulkActions.classList.remove('active');
                els.selectModeBtn.textContent = '多选模式';
                els.selectModeBtn.style.backgroundColor = 'var(--primary-color)';
                
                // 初始化新标签页
                actions.updateCategoryOptions();
                actions.updateBulkCategoryOptions();
                actions.updateSidebarCategories();
                actions.updateSidebarTags();
                actions.updateViewMode();
                actions.applyFilterAndSort();
            },

            showAddTabModal() {
                document.getElementById('tab-modal').style.display = 'flex';
                document.getElementById('new-tab-name').value = '';
                document.getElementById('new-tab-name').focus();
            },

            addTab(tabName) {
                if (!tabName.trim()) {
                    utils.ui.showToast('页签名称不能为空', 'warning');
                    return false;
                }
                
                // 创建一个唯一ID
                const tabId = 'tab_' + Date.now();
                
                // 更新标签页信息
                tabSystem.tabs.push(tabId);
                tabSystem.tabNames[tabId] = tabName;
                
                // 初始化新标签页的数据
                tabSystem.data[tabId] = {
                    items: [],
                    categories: ['默认', '工作', '学习', '创意'],
                    allTags: new Set()
                };
                
                // 保存标签页配置
                utils.storage.save('tabs', {
                    tabs: tabSystem.tabs,
                    tabNames: tabSystem.tabNames
                });
                
                // 切换到新标签页
                tabSystem.renderTabs();
                tabSystem.switchTab(tabId);
                
                utils.ui.showToast(`已添加"${tabName}"页签`);
                return true;
            },

            removeTab(tabId) {
                if (tabId === 'prompts' || tabId === 'macros') {
                    utils.ui.showToast('默认页签不能删除', 'warning');
                    return;
                }
                
                if (!confirm(`确定要删除"${this.tabNames[tabId]}"页签吗？这将永久删除该页签的所有数据。`)) {
                    return;
                }
                
                // 如果当前正在该标签页，则切换到第一个标签页
                if (this.currentTab === tabId) {
                    this.switchTab(this.tabs[0]);
                }
                
                // 移除标签页数据
                this.tabs = this.tabs.filter(tab => tab !== tabId);
                delete this.tabNames[tabId];
                delete this.data[tabId];
                
                // 从本地存储中移除该标签页的数据
                localStorage.removeItem(`${tabId}_items`);
                localStorage.removeItem(`${tabId}_categories`);
                localStorage.removeItem(`${tabId}_state`);
                
                // 更新标签页配置
                utils.storage.save('tabs', {
                    tabs: this.tabs,
                    tabNames: this.tabNames
                });
                
                // 重新渲染标签页
                this.renderTabs();
                
                utils.ui.showToast('页签已删除');
            },

            getCurrentData() {
                return this.data[this.currentTab];
            },

            saveData() {
                // 保存当前标签页的数据
                utils.storage.save(`${this.currentTab}_items`, this.getCurrentData().items);
                utils.storage.save(`${this.currentTab}_categories`, this.getCurrentData().categories);

                // 保存标签页配置
                utils.storage.save('tabs', {
                    tabs: this.tabs,
                    tabNames: this.tabNames
                });
            }
        };

        // DOM元素引用
        const els = {
            dropArea: document.getElementById('drop-area'),
            fileInput: document.getElementById('file-input'),
            fileSelectBtn: document.getElementById('file-select-btn'),
            promptContainer: document.getElementById('prompt-container'),
            toast: document.getElementById('toast'),
            cardViewBtn: document.getElementById('card-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            newItemBtn: document.getElementById('new-item-btn'),
            modal: document.getElementById('modal'),
            closeModalBtn: document.querySelector('.close-modal'),
            savePromptBtn: document.getElementById('save-prompt-btn'),
            promptTitleInput: document.getElementById('prompt-title-input'),
            promptCategoryInput: document.getElementById('prompt-category-input'),
            promptTagsInput: document.getElementById('prompt-tags-input'),
            promptTagsContainer: document.getElementById('prompt-tags-container'),
            promptContentInput: document.getElementById('prompt-content-input'),
            searchInput: document.getElementById('search-input'),
            sortOptions: document.getElementById('sort-options'),
            groupOptions: document.getElementById('group-options'),
            manageCategoriesBtn: document.getElementById('manage-categories-btn'),
            categoryManager: document.getElementById('category-manager'),
            closeCategoryManager: document.querySelector('.close-category-manager'),
            categoryList: document.getElementById('category-list'),
            newCategoryInput: document.getElementById('new-category-input'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            categorySidebarList: document.getElementById('category-sidebar-list'),
            menuToggle: document.getElementById('menu-toggle'),
            sidebar: document.getElementById('sidebar'),
            tagSidebarList: document.getElementById('tag-sidebar-list'),
            tagSearchInput: document.getElementById('tag-search-input'),
            clearTagSearch: document.getElementById('clear-tag-search'),
            manageTagsBtn: document.getElementById('manage-tags-btn'),
            tagsManager: document.getElementById('tags-manager'),
            closeTagsManager: document.querySelector('.close-tags-manager'),
            tagsManagerList: document.getElementById('tags-manager-list'),
            newTagInput: document.getElementById('new-tag-input'),
            addTagBtn: document.getElementById('add-tag-btn'),
            tagManagerSearch: document.getElementById('tag-manager-search'),
            clearTagManagerSearch: document.getElementById('clear-tag-manager-search'),
            selectModeBtn: document.getElementById('select-mode-btn'),
            bulkActions: document.getElementById('bulk-actions'),
            bulkCount: document.getElementById('bulk-count'),
            cancelSelectBtn: document.getElementById('cancel-select-btn'),
            bulkCategoryBtn: document.getElementById('bulk-category-btn'),
            bulkTagsBtn: document.getElementById('bulk-tags-btn'),
            bulkDeleteBtn: document.getElementById('bulk-delete-btn'),
            multiActionModal: document.getElementById('multi-action-modal'),
            closeMultiActionModal: document.querySelector('.close-multi-action-modal'),
            bulkCategorySelect: document.getElementById('bulk-category-select'),
            applyBulkCategoryBtn: document.getElementById('apply-bulk-category-btn'),
            tagsModal: document.getElementById('tags-modal'),
            closeTagsModal: document.querySelector('.close-tags-modal'),
            bulkTagsInput: document.getElementById('bulk-tags-input'),
            bulkTagsContainer: document.getElementById('bulk-tags-container'),
            tagsActionMode: document.getElementById('tags-action-mode'),
            applyBulkTagsBtn: document.getElementById('apply-bulk-tags-btn'),
            backupMenuBtn: document.getElementById('backup-menu-btn'),
            restoreMenuBtn: document.getElementById('restore-menu-btn'),
            backupModal: document.getElementById('backup-modal'),
            closeBackupModal: document.querySelector('.close-backup-modal'),
            localBackupBtn: document.getElementById('local-backup-btn'),
            restoreModal: document.getElementById('restore-modal'),
            closeRestoreModal: document.querySelector('.close-restore-modal'),
            restoreFileInput: document.getElementById('restore-file-input'),
            localRestoreStatus: document.getElementById('local-restore-status'),
            tabModal: document.getElementById('tab-modal'),
            closeTabModal: document.querySelector('.close-tab-modal'),
            newTabName: document.getElementById('new-tab-name'),
            addTabBtn: document.getElementById('add-tab-btn')
        };

        // 应用状态
        const state = {
            currentView: 'card',
            editingIndex: -1,
            currentFilter: 'all',
            currentFilterType: 'category',
            currentSort: 'newest',
            currentGroup: 'none',
            isSelectMode: false,
            selectedPrompts: [],

            // 保存当前标签页状态
            saveTabState() {
                utils.storage.save(`${tabSystem.currentTab}_state`, {
                    view: this.currentView,
                    filter: this.currentFilter,
                    filterType: this.currentFilterType,
                    sort: this.currentSort,
                    group: this.currentGroup
                });
            }
        };

        // 辅助函数
        const utils = {
            // 本地存储操作
            storage: {
                // 保存数据到本地存储
                save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
                // 从本地存储加载数据
                load: (key) => {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                }
            },
            
            // 标签处理
            tags: {
                // 解析输入的标签
                parse: (input) => {
                    if (!input) return [];
                    return input.split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag)
                        .filter((tag, index, self) => self.indexOf(tag) === index);
                },
                
                // 更新标签显示
                updateDisplay: (tagsArray, container) => {
                    container.innerHTML = '';
                    if (!tagsArray || tagsArray.length === 0) return;
                    
                    tagsArray.forEach(tag => {
                        const tagItem = document.createElement('div');
                        tagItem.className = 'tag-item';
                        tagItem.innerHTML = `
                            <span class="tag-text">${tag}</span>
                            <span class="tag-remove" data-tag="${tag}">×</span>
                        `;
                        container.appendChild(tagItem);
                    });
                    
                    // 添加删除标签事件
                    container.querySelectorAll('.tag-remove').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const tag = btn.dataset.tag;
                            let inputField;
                            
                            if (container === els.promptTagsContainer) {
                                inputField = els.promptTagsInput;
                            } else if (container === els.bulkTagsContainer) {
                                inputField = els.bulkTagsInput;
                            }
                            
                            if (inputField) {
                                const currentTags = inputField.value.split(',')
                                    .map(t => t.trim())
                                    .filter(t => t && t !== tag);
                                inputField.value = currentTags.join(', ');
                                
                                if (container === els.promptTagsContainer) {
                                    utils.tags.updateDisplay(currentTags, els.promptTagsContainer);
                                } else if (container === els.bulkTagsContainer) {
                                    utils.tags.updateDisplay(currentTags, els.bulkTagsContainer);
                                }
                            }
                        });
                    });
                }
            },
            
            // UI相关辅助函数
            ui: {
                // 显示提示信息
                showToast: (message, type = 'success') => {
                    els.toast.textContent = message;
                    els.toast.className = 'toast';
                    
                    if (type === 'warning') {
                        els.toast.classList.add('warning');
                    } else if (type === 'error') {
                        els.toast.classList.add('error');
                    }
                    
                    els.toast.classList.add('show');
                    setTimeout(() => els.toast.classList.remove('show'), 3000);
                },
                
                // 显示模态框
                showModal: (isEditing = false, index = -1) => {
                    state.editingIndex = index;
                    
                    if (isEditing) {
                        const currentData = tabSystem.getCurrentData();
                        document.getElementById('modal-title').textContent = '编辑项目';
                        els.promptTitleInput.value = currentData.items[index].title;
                        els.promptContentInput.value = currentData.items[index].content;
                        els.promptCategoryInput.value = currentData.items[index].category || '';
                        
                        const tags = currentData.items[index].tags || [];
                        els.promptTagsInput.value = tags.join(', ');
                        utils.tags.updateDisplay(tags, els.promptTagsContainer);
                    } else {
                        document.getElementById('modal-title').textContent = '新建项目';
                        els.promptTitleInput.value = '';
                        els.promptContentInput.value = '';
                        els.promptCategoryInput.value = '';
                        els.promptTagsInput.value = '';
                        els.promptTagsContainer.innerHTML = '';
                    }
                    
                    els.modal.style.display = 'flex';
                }
            },
            
            // 数据操作函数
            data: {
                // 添加项目
                addItem: (title, content, category = '', tags = []) => {
                    const currentData = tabSystem.getCurrentData();
                    currentData.items.push({ title, content, category, tags });
                    
                    if (tags && tags.length > 0) {
                        tags.forEach(tag => currentData.allTags.add(tag));
                    }
                    
                    tabSystem.saveData();
                    actions.applyFilterAndSort();
                },
                
                // 更新项目
                updateItem: (index, title, content, category, tags) => {
                    const currentData = tabSystem.getCurrentData();
                    
                    if (currentData.items[index].tags) {
                        currentData.items[index].tags.forEach(tag => {
                            const isTagUsedElsewhere = currentData.items.some((p, i) => 
                                i !== index && p.tags && p.tags.includes(tag)
                            );
                            
                            if (!isTagUsedElsewhere) {
                                currentData.allTags.delete(tag);
                            }
                        });
                    }
                    
                    currentData.items[index] = { title, content, category, tags };
                    
                    if (tags && tags.length > 0) {
                        tags.forEach(tag => currentData.allTags.add(tag));
                    }
                    
                    tabSystem.saveData();
                    actions.applyFilterAndSort();
                },
                
                // 删除项目
                deleteItem: (index) => {
                    if (confirm('确定要删除这个项目吗？')) {
                        const currentData = tabSystem.getCurrentData();
                        
                        if (currentData.items[index].tags) {
                            currentData.items[index].tags.forEach(tag => {
                                const isTagUsedElsewhere = currentData.items.some((p, i) => 
                                    i !== index && p.tags && p.tags.includes(tag)
                                );
                                
                                if (!isTagUsedElsewhere) {
                                    currentData.allTags.delete(tag);
                                }
                            });
                        }
                        
                        currentData.items.splice(index, 1);
                        tabSystem.saveData();
                        actions.applyFilterAndSort();
                        utils.ui.showToast('项目已删除');
                    }
                },
                
                // 更新全局标签集合
                updateGlobalTags: () => {
                    const currentData = tabSystem.getCurrentData();
                    currentData.allTags.clear();
                    currentData.items.forEach(item => {
                        if (item.tags && item.tags.length > 0) {
                            item.tags.forEach(tag => currentData.allTags.add(tag));
                        }
                    });
                }
            }
        };

        // 应用操作
        const actions = {
            // 初始化应用
            init: () => {
                // 初始化页签系统
                tabSystem.init();
                
                // 加载视图模式
                const savedView = utils.storage.load(`${tabSystem.currentTab}_state`);
                if (savedView) {
                    state.currentView = savedView.view || 'card';
                    state.currentFilter = savedView.filter || 'all';
                    state.currentFilterType = savedView.filterType || 'category';
                    state.currentSort = savedView.sort || 'newest';
                    state.currentGroup = savedView.group || 'none';
                    els.sortOptions.value = state.currentSort;
                    els.groupOptions.value = state.currentGroup;
                }
                
                // 更新UI
                actions.updateCategoryOptions();
                actions.updateBulkCategoryOptions();
                actions.updateSidebarCategories();
                actions.updateSidebarTags();
                actions.updateViewMode();
                actions.applyFilterAndSort();
                
                // 设置事件监听
                setupEventListeners();
            },
            
            // 更新分类选项
            updateCategoryOptions: () => {
                const currentData = tabSystem.getCurrentData();
                els.promptCategoryInput.innerHTML = '<option value="">未分类</option>';
                currentData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    els.promptCategoryInput.appendChild(option);
                });
            },
            
            // 更新批量操作的分类选项
            updateBulkCategoryOptions: () => {
                const currentData = tabSystem.getCurrentData();
                els.bulkCategorySelect.innerHTML = '<option value="">未分类</option>';
                currentData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    els.bulkCategorySelect.appendChild(option);
                });
            },
            
            // 计算每个分类的项目数量
            getCategoryCounts: () => {
                const currentData = tabSystem.getCurrentData();
                const counts = { '': 0 };
                currentData.categories.forEach(category => {
                    counts[category] = 0;
                });
                
                currentData.items.forEach(item => {
                    const category = item.category || '';
                    if (counts[category] !== undefined) {
                        counts[category]++;
                    }
                });
                
                return counts;
            },
            
            // 计算每个标签的项目数量
            getTagCounts: () => {
                const currentData = tabSystem.getCurrentData();
                const counts = {};
                
                currentData.items.forEach(item => {
                    if (item.tags && item.tags.length > 0) {
                        item.tags.forEach(tag => {
                            if (!counts[tag]) counts[tag] = 0;
                            counts[tag]++;
                        });
                    }
                });
                
                return counts;
            },
            
            // 更新左侧分类列表
            updateSidebarCategories: () => {
                const currentData = tabSystem.getCurrentData();
                const categoryCounts = actions.getCategoryCounts();
                let totalCount = currentData.items.length;
                
                els.categorySidebarList.innerHTML = `
                    <li class="sidebar-item" data-category="all" data-type="category">
                        <span>所有分类</span>
                        <span class="count">${totalCount}</span>
                    </li>
                `;
                
                currentData.categories.forEach(category => {
                    const categoryItem = document.createElement('li');
                    categoryItem.className = 'sidebar-item';
                    categoryItem.dataset.category = category;
                    categoryItem.dataset.type = 'category';
                    categoryItem.innerHTML = `
                        <span>${category}</span>
                        <span class="count">${categoryCounts[category] || 0}</span>
                    `;
                    els.categorySidebarList.appendChild(categoryItem);
                });
                
                const uncategorizedItem = document.createElement('li');
                uncategorizedItem.className = 'sidebar-item';
                uncategorizedItem.dataset.category = '';
                uncategorizedItem.dataset.type = 'category';
                uncategorizedItem.innerHTML = `
                    <span>未分类</span>
                    <span class="count">${categoryCounts[''] || 0}</span>
                `;
                els.categorySidebarList.appendChild(uncategorizedItem);
                
                // 设置当前选中的项目
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    if (item.dataset.category === state.currentFilter && item.dataset.type === state.currentFilterType) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // 添加点击事件
                els.categorySidebarList.querySelectorAll('.sidebar-item').forEach(item => {
                    item.addEventListener('click', function() {
                        state.currentFilter = this.dataset.category;
                        state.currentFilterType = this.dataset.type;
                        state.saveTabState();
                        
                        document.querySelectorAll('.sidebar-item, .tag-sidebar-item').forEach(el => {
                            el.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        actions.applyFilterAndSort();
                        
                        if (window.innerWidth <= 768) {
                            els.sidebar.classList.remove('active');
                        }
                    });
                });
            },
            
            // 更新左侧标签列表
            updateSidebarTags: () => {
                const currentData = tabSystem.getCurrentData();
                const tagCounts = actions.getTagCounts();
                const searchTerm = els.tagSearchInput.value.trim().toLowerCase();
                
                let tags = Array.from(currentData.allTags).sort();
                
                if (searchTerm) {
                    tags = tags.filter(tag => tag.toLowerCase().includes(searchTerm));
                }
                
                els.tagSidebarList.innerHTML = '';
                
                if (tags.length === 0) {
                    els.tagSidebarList.innerHTML = '<li class="sidebar-item">无标签</li>';
                } else {
                    tags.forEach(tag => {
                        const tagItem = document.createElement('li');
                        tagItem.className = 'tag-sidebar-item';
                        tagItem.dataset.category = tag;
                        tagItem.dataset.type = 'tag';
                        tagItem.innerHTML = `
                            <span class="tag-icon"></span>
                            <span class="tag-name">${tag}</span>
                            <span class="count">${tagCounts[tag] || 0}</span>
                        `;
                        els.tagSidebarList.appendChild(tagItem);
                    });
                }
                
                document.querySelectorAll('.tag-sidebar-item').forEach(item => {
                    if (item.dataset.category === state.currentFilter && state.currentFilterType === 'tag') {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                    
                    item.addEventListener('click', function() {
                        state.currentFilter = this.dataset.category;
                        state.currentFilterType = 'tag';
                        state.saveTabState();
                        
                        document.querySelectorAll('.sidebar-item, .tag-sidebar-item').forEach(el => {
                            el.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        actions.applyFilterAndSort();
                        
                        if (window.innerWidth <= 768) {
                            els.sidebar.classList.remove('active');
                        }
                    });
                });
            },
            
            // 更新标签管理列表
            updateTagsManagerList: () => {
                const currentData = tabSystem.getCurrentData();
                const searchTerm = els.tagManagerSearch.value.trim().toLowerCase();
                let tags = Array.from(currentData.allTags).sort();
                const tagCounts = actions.getTagCounts();
                
                if (searchTerm) {
                    tags = tags.filter(tag => tag.toLowerCase().includes(searchTerm));
                }
                
                els.tagsManagerList.innerHTML = '';
                
                if (tags.length === 0) {
                    els.tagsManagerList.innerHTML = '<div class="tag-manager-item">无标签</div>';
                } else {
                    tags.forEach(tag => {
                        const tagItem = document.createElement('div');
                        tagItem.className = 'tag-manager-item';
                        tagItem.innerHTML = `
                            <span>
                                <span class="tag-dot"></span>
                                ${tag}
                                <span class="count">${tagCounts[tag] || 0}</span>
                            </span>
                            <button class="delete-btn" data-tag="${tag}">×</button>
                        `;
                        els.tagsManagerList.appendChild(tagItem);
                    });
                }
                
                els.tagsManagerList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tag = btn.dataset.tag;
                        actions.deleteTag(tag);
                    });
                });
            },
            
            // 应用过滤和排序
            applyFilterAndSort: () => {
                const currentData = tabSystem.getCurrentData();
                let filteredItems = currentData.items;
                
                // 搜索过滤
                const searchQuery = els.searchInput.value.trim().toLowerCase();
                if (searchQuery) {
                    filteredItems = filteredItems.filter(item => 
                        item.title.toLowerCase().includes(searchQuery) || 
                        item.content.toLowerCase().includes(searchQuery) || 
                        (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                    );
                }
                
                // 分类或标签过滤
                if (state.currentFilter !== 'all') {
                    if (state.currentFilterType === 'category') {
                        filteredItems = filteredItems.filter(item => 
                            item.category === state.currentFilter);
                    } else if (state.currentFilterType === 'tag') {
                        filteredItems = filteredItems.filter(item => 
                            item.tags && item.tags.includes(state.currentFilter));
                    }
                }
                
                // 排序
                switch (state.currentSort) {
                    case 'newest':
                        // 不需要反转，因为默认就是最新的在前面
                        // filteredItems = [...filteredItems].reverse();
                        break;
                    case 'oldest':
                        // 如果要显示最旧的在前面，才需要反转
                        filteredItems = [...filteredItems].reverse();
                        break;
                    case 'alpha-asc':
                        filteredItems = [...filteredItems].sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'alpha-desc':
                        filteredItems = [...filteredItems].sort((a, b) => b.title.localeCompare(a.title));
                        break;
                }
                
                // 应用分组并渲染
                actions.renderItemsByGroup(filteredItems);
                
                // 更新侧边栏计数
                actions.updateSidebarCategories();
                actions.updateSidebarTags();
            },
            
            // 根据分组方式渲染项目
            renderItemsByGroup: (filteredItems) => {
                const currentData = tabSystem.getCurrentData();
                els.promptContainer.innerHTML = '';
                
                if (state.currentGroup === 'none') {
                    // 不分组
                    const promptGrid = document.createElement('div');
                    promptGrid.className = state.currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                    els.promptContainer.appendChild(promptGrid);
                    
                    actions.renderItemsToContainer(filteredItems, promptGrid);
                } else if (state.currentGroup === 'category') {
                    // 按分类分组
                    // 收集所有分类，包括未分类
                    let groups = [''];
                    filteredItems.forEach(item => {
                        if (item.category && !groups.includes(item.category)) {
                            groups.push(item.category);
                        }
                    });
                    
                    // 按字母顺序排序分类，但保持"未分类"在最后
                    const uncategorized = groups.shift();
                    groups.sort();
                    groups.push(uncategorized);
                    
                    // 为每个分类创建组
                    groups.forEach(group => {
                        const groupItems = filteredItems.filter(p => p.category === group);
                        if (groupItems.length > 0) {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'prompt-group';
                            
                            const groupHeader = document.createElement('div');
                            groupHeader.className = 'group-header';
                            groupHeader.textContent = group || '未分类';
                            groupDiv.appendChild(groupHeader);
                            
                            const promptGrid = document.createElement('div');
                            promptGrid.className = state.currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                            groupDiv.appendChild(promptGrid);
                            
                            actions.renderItemsToContainer(groupItems, promptGrid);
                            
                            els.promptContainer.appendChild(groupDiv);
                        }
                    });
                } else if (state.currentGroup === 'tags') {
                    // 按标签分组
                    // 收集所有使用过的标签
                    let usedTags = new Set();
                    filteredItems.forEach(item => {
                        if (item.tags && item.tags.length > 0) {
                            item.tags.forEach(tag => usedTags.add(tag));
                        }
                    });
                    
                    let tags = Array.from(usedTags).sort();
                    
                    // 添加"无标签"分组
                    const noTagItems = filteredItems.filter(p => !p.tags || p.tags.length === 0);
                    if (noTagItems.length > 0) {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'prompt-group';
                        
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header';
                        groupHeader.textContent = '无标签';
                        groupDiv.appendChild(groupHeader);
                        
                        const promptGrid = document.createElement('div');
                        promptGrid.className = state.currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                        groupDiv.appendChild(promptGrid);
                        
                        actions.renderItemsToContainer(noTagItems, promptGrid);
                        
                        els.promptContainer.appendChild(groupDiv);
                    }
                    
                    // 为每个标签创建组
                    tags.forEach(tag => {
                        const groupItems = filteredItems.filter(p => p.tags && p.tags.includes(tag));
                        if (groupItems.length > 0) {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'prompt-group';
                            
                            const groupHeader = document.createElement('div');
                            groupHeader.className = 'group-header';
                            groupHeader.textContent = `标签: ${tag}`;
                            groupDiv.appendChild(groupHeader);
                            
                            const promptGrid = document.createElement('div');
                            promptGrid.className = state.currentView === 'list' ? 'prompt-grid list-view' : 'prompt-grid';
                            groupDiv.appendChild(promptGrid);
                            
                            actions.renderItemsToContainer(groupItems, promptGrid);
                            
                            els.promptContainer.appendChild(groupDiv);
                        }
                    });
                }
                
                if (state.isSelectMode && state.selectedPrompts.length > 0) {
                    actions.updateSelectedState();
                }
            },
            
            // 渲染项目到指定容器
            renderItemsToContainer: (itemsToRender, container) => {
                const currentData = tabSystem.getCurrentData();
                itemsToRender.forEach((item, index) => {
                    const originalIndex = currentData.items.findIndex(p => 
                        p.title === item.title && p.content === item.content);
                    
                    const promptCard = document.createElement('div');
                    promptCard.className = 'prompt-card';
                    promptCard.dataset.index = originalIndex;
                    
                    let categoryHtml = item.category 
                        ? `<div class="prompt-category">${item.category}</div>` 
                        : '';
                    
                    let tagsHtml = '';
                    if (item.tags && item.tags.length > 0) {
                        tagsHtml = '<div class="prompt-tags">';
                        item.tags.forEach(tag => {
                            tagsHtml += `<span class="prompt-tag">${tag}</span>`;
                        });
                        tagsHtml += '</div>';
                    }
                    
                    let checkboxHtml = state.isSelectMode ? 
                        `<div class="checkbox-container">
                            <input type="checkbox" class="prompt-checkbox" data-index="${originalIndex}">
                        </div>` : '';
                    
                    promptCard.innerHTML = `
                        ${checkboxHtml}
                        <div class="prompt-title">
                            <span>${item.title}</span>
                            <div class="card-actions">
                                <button class="edit-btn" data-index="${originalIndex}">✎</button>
                                <button class="delete-btn" data-index="${originalIndex}">×</button>
                            </div>
                        </div>
                        <div class="prompt-content">${item.content}</div>
                        ${categoryHtml}
                        ${tagsHtml}
                    `;
                    
                    // 点击复制功能
                    promptCard.addEventListener('click', (e) => {
                        // 多选模式处理
                        if (state.isSelectMode) {
                            if (!e.target.classList.contains('edit-btn') && 
                                !e.target.classList.contains('delete-btn')) {
                                const checkbox = promptCard.querySelector('.prompt-checkbox');
                                checkbox.checked = !checkbox.checked;
                                actions.toggleItemSelection(originalIndex, checkbox.checked);
                            }
                            return;
                        }
                        
                        // 忽略删除和编辑按钮点击
                        if (e.target.classList.contains('delete-btn') || 
                            e.target.classList.contains('edit-btn')) {
                            return;
                        }
                        
                        // 复制到剪贴板
                        navigator.clipboard.writeText(item.content)
                            .then(() => utils.ui.showToast('已复制到剪贴板'))
                            .catch(err => utils.ui.showToast('复制失败: ' + err, 'error'));
                    });
                    
                    container.appendChild(promptCard);
                });
                
                // 添加复选框事件
                if (state.isSelectMode) {
                    container.querySelectorAll('.prompt-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const index = parseInt(this.dataset.index);
                            actions.toggleItemSelection(index, this.checked);
                        });
                    });
                }
                
                // 添加删除按钮事件
                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.index);
                        utils.data.deleteItem(index);
                    });
                });
                
                // 添加编辑按钮事件
                container.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.index);
                        utils.ui.showModal(true, index);
                    });
                });
            },
            
            // 从Markdown文件创建项目
            createItemFromMarkdown: (file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    let title = file.name.replace('.md', '');
                    
                    if (lines[0].startsWith('# ')) {
                        title = lines[0].substring(2).trim();
                    }
                    
                    utils.data.addItem(title, content, '', []);
                    utils.ui.showToast('项目已添加');
                };
                reader.readAsText(file);
            },
            
            // 更新视图模式
            updateViewMode: () => {
                if (state.currentView === 'list') {
                    els.listViewBtn.style.backgroundColor = 'var(--secondary-color)';
                    els.cardViewBtn.style.backgroundColor = 'var(--primary-color)';
                } else {
                    els.cardViewBtn.style.backgroundColor = 'var(--secondary-color)';
                    els.listViewBtn.style.backgroundColor = 'var(--primary-color)';
                }
                actions.applyFilterAndSort();
            },
            
            // 渲染分类管理列表
            renderCategoryList: () => {
                const currentData = tabSystem.getCurrentData();
                const categoryCounts = actions.getCategoryCounts();
                els.categoryList.innerHTML = '';
                
                currentData.categories.forEach((category, index) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <span>${category} <span class="count">${categoryCounts[category] || 0}</span></span>
                        <button class="delete-btn" data-index="${index}">×</button>
                    `;
                    els.categoryList.appendChild(categoryItem);
                });
                
                // 添加删除分类按钮事件
                els.categoryList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        actions.deleteCategory(index);
                    });
                });
            },
            
            // 添加新分类
            addCategory: (categoryName) => {
                const currentData = tabSystem.getCurrentData();
                if (!categoryName) return;
                
                if (currentData.categories.includes(categoryName)) {
                    utils.ui.showToast('该分类已存在', 'warning');
                    return;
                }
                
                currentData.categories.push(categoryName);
                tabSystem.saveData();
                actions.updateCategoryOptions();
                actions.updateBulkCategoryOptions();
                actions.updateSidebarCategories();
                actions.renderCategoryList();
                utils.ui.showToast('分类已添加');
            },
            
            // 删除分类
            deleteCategory: (index) => {
                const currentData = tabSystem.getCurrentData();
                const categoryToDelete = currentData.categories[index];
                
                if (confirm(`确定要删除"${categoryToDelete}"分类吗？这不会删除该分类下的项目，但它们将变为未分类状态。`)) {
                    // 将该分类下的所有项目设为未分类
                    currentData.items.forEach(item => {
                        if (item.category === categoryToDelete) {
                            item.category = '';
                        }
                    });
                    
                    currentData.categories.splice(index, 1);
                    tabSystem.saveData();
                    actions.updateCategoryOptions();
                    actions.updateBulkCategoryOptions();
                    actions.updateSidebarCategories();
                    actions.renderCategoryList();
                    
                    // 如果当前过滤器是被删除的分类，切换到"所有分类"
                    if (state.currentFilter === categoryToDelete && state.currentFilterType === 'category') {
                        state.currentFilter = 'all';
                        state.currentFilterType = 'category';
                        state.saveTabState();
                    }
                    
                    actions.applyFilterAndSort();
                    utils.ui.showToast('分类已删除');
                }
            },
            
            // 添加新标签
            addTag: (tagName) => {
                const currentData = tabSystem.getCurrentData();
                if (!tagName) return;
                
                if (currentData.allTags.has(tagName)) {
                    utils.ui.showToast('该标签已存在', 'warning');
                    return;
                }
                
                currentData.allTags.add(tagName);
                actions.updateSidebarTags();
                actions.updateTagsManagerList();
                utils.ui.showToast('标签已添加');
            },
            
            // 删除标签
            deleteTag: (tagName) => {
                const currentData = tabSystem.getCurrentData();
                if (confirm(`确定要删除"${tagName}"标签吗？这将从所有使用该标签的项目中移除它。`)) {
                    // 从所有项目中移除该标签
                    currentData.items.forEach(item => {
                        if (item.tags && item.tags.includes(tagName)) {
                            item.tags = item.tags.filter(tag => tag !== tagName);
                        }
                    });
                    
                    // 从全局标签集合中移除
                    currentData.allTags.delete(tagName);
                    
                    tabSystem.saveData();
                    actions.updateSidebarTags();
                    actions.updateTagsManagerList();
                    
                    // 如果当前过滤器是被删除的标签，切换到"所有分类"
                    if (state.currentFilter === tagName && state.currentFilterType === 'tag') {
                        state.currentFilter = 'all';
                        state.currentFilterType = 'category';
                        state.saveTabState();
                    }
                    
                    actions.applyFilterAndSort();
                    utils.ui.showToast('标签已删除');
                }
            },
            
            // 切换多选模式
            toggleSelectMode: () => {
                state.isSelectMode = !state.isSelectMode;
                state.selectedPrompts = [];
                
                if (state.isSelectMode) {
                    els.selectModeBtn.textContent = '退出多选';
                    els.selectModeBtn.style.backgroundColor = 'var(--secondary-color)';
                    els.bulkCount.textContent = '0';
                    els.bulkActions.classList.add('active');
                } else {
                    els.selectModeBtn.textContent = '多选模式';
                    els.selectModeBtn.style.backgroundColor = 'var(--primary-color)';
                    els.bulkActions.classList.remove('active');
                }
                
                actions.applyFilterAndSort();
            },
            
            // 切换项目选中状态
            toggleItemSelection: (index, isSelected) => {
                const card = document.querySelector(`.prompt-card[data-index="${index}"]`);
                
                if (isSelected) {
                    if (!state.selectedPrompts.includes(index)) {
                        state.selectedPrompts.push(index);
                    }
                    if (card) card.classList.add('selected');
                } else {
                    state.selectedPrompts = state.selectedPrompts.filter(i => i !== index);
                    if (card) card.classList.remove('selected');
                }
                
                els.bulkCount.textContent = state.selectedPrompts.length;
            },
            
            // 更新选中状态
            updateSelectedState: () => {
                state.selectedPrompts.forEach(index => {
                    const checkbox = document.querySelector(`.prompt-checkbox[data-index="${index}"]`);
                    const card = document.querySelector(`.prompt-card[data-index="${index}"]`);
                    
                    if (checkbox) checkbox.checked = true;
                    if (card) card.classList.add('selected');
                });
                
                els.bulkCount.textContent = state.selectedPrompts.length;
            },
            
            // 批量删除项目
            bulkDeleteItems: () => {
                if (state.selectedPrompts.length === 0) {
                    utils.ui.showToast('请先选择要删除的项目', 'warning');
                    return;
                }
                
                if (confirm(`确定要删除选中的 ${state.selectedPrompts.length} 个项目吗？`)) {
                    const currentData = tabSystem.getCurrentData();
                    // 按照索引从大到小排序，以避免删除时索引变化的问题
                    state.selectedPrompts.sort((a, b) => b - a);
                    
                    // 从所有标签集合中移除将被删除的标签
                    state.selectedPrompts.forEach(index => {
                        if (currentData.items[index] && currentData.items[index].tags) {
                            currentData.items[index].tags.forEach(tag => {
                                // 检查其他未被删除的项目是否还在使用这个标签
                                const isTagUsedElsewhere = currentData.items.some((p, i) => 
                                    !state.selectedPrompts.includes(i) && p.tags && p.tags.includes(tag)
                                );
                                
                                if (!isTagUsedElsewhere) {
                                    currentData.allTags.delete(tag);
                                }
                            });
                        }
                    });
                    
                    state.selectedPrompts.forEach(index => {
                        currentData.items.splice(index, 1);
                    });
                    
                    tabSystem.saveData();
                    state.selectedPrompts = [];
                    els.bulkCount.textContent = '0';
                    
                    actions.applyFilterAndSort();
                    utils.ui.showToast('已删除选中的项目');
                }
            },
            
            // 批量设置分类
            showBulkCategoryModal: () => {
                if (state.selectedPrompts.length === 0) {
                    utils.ui.showToast('请先选择要设置分类的项目', 'warning');
                    return;
                }
                
                els.multiActionModal.style.display = 'flex';
            },
            
            // 批量设置标签
            showBulkTagsModal: () => {
                if (state.selectedPrompts.length === 0) {
                    utils.ui.showToast('请先选择要设置标签的项目', 'warning');
                    return;
                }
                
                els.bulkTagsInput.value = '';
                els.bulkTagsContainer.innerHTML = '';
                
                els.tagsModal.style.display = 'flex';
            },
            
            // 应用批量分类设置
            applyBulkCategory: () => {
                const currentData = tabSystem.getCurrentData();
                const category = els.bulkCategorySelect.value;
                const countBefore = state.selectedPrompts.length;
                
                state.selectedPrompts.forEach(index => {
                    if (index < currentData.items.length) {
                        currentData.items[index].category = category;
                    }
                });
                
                tabSystem.saveData();
                els.multiActionModal.style.display = 'none';
                
                if (state.currentFilterType === 'category' && state.currentFilter !== 'all' && state.currentFilter !== category) {
                    state.selectedPrompts = [];
                    els.bulkCount.textContent = '0';
                    utils.ui.showToast(`已将 ${countBefore} 个项目移至"${category || '未分类'}"分类`);
                } else {
                    utils.ui.showToast(`已将 ${countBefore} 个项目设为"${category || '未分类'}"分类`);
                }
                
                actions.applyFilterAndSort();
            },
            
            // 应用批量标签设置
            applyBulkTags: () => {
                const currentData = tabSystem.getCurrentData();
                const tagsInput = els.bulkTagsInput.value;
                const newTags = utils.tags.parse(tagsInput);
                const mode = els.tagsActionMode.value;
                const countBefore = state.selectedPrompts.length;
                
                state.selectedPrompts.forEach(index => {
                    if (index < currentData.items.length) {
                        let currentTags = currentData.items[index].tags || [];
                        
                        if (mode === 'replace') {
                            currentData.items[index].tags = [...newTags];
                        } else if (mode === 'add') {
                            const combinedTags = [...currentTags, ...newTags];
                            currentData.items[index].tags = combinedTags.filter((tag, i, self) => self.indexOf(tag) === i);
                        } else if (mode === 'remove') {
                            currentData.items[index].tags = currentTags.filter(tag => !newTags.includes(tag));
                        }
                    }
                });
                
                utils.data.updateGlobalTags();
                
                tabSystem.saveData();
                els.tagsModal.style.display = 'none';
                
                let actionMsg;
                switch (mode) {
                    case 'replace': actionMsg = '替换了'; break;
                    case 'add': actionMsg = '添加了'; break;
                    case 'remove': actionMsg = '移除了'; break;
                }
                
                utils.ui.showToast(`已为 ${countBefore} 个项目${actionMsg}标签`);
                actions.applyFilterAndSort();
            },
            
            // 备份恢复相关功能
            
            // 创建备份数据
            createBackupData: () => {
                // 备份所有页签的数据
                const backup = {
                    tabs: tabSystem.tabs,
                    tabNames: tabSystem.tabNames,
                    tabData: {},
                    version: "2.0",
                    timestamp: new Date().toISOString()
                };
                
                // 为每个标签页保存数据
                tabSystem.tabs.forEach(tab => {
                    backup.tabData[tab] = {
                        items: tabSystem.data[tab].items,
                        categories: tabSystem.data[tab].categories
                    };
                });
                
                return JSON.stringify(backup, null, 2);
            },
            
            // 本地备份
            localBackup: () => {
                const backupData = actions.createBackupData();
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `data_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                utils.ui.showToast('备份文件已下载');
            },
            
            // 从本地文件恢复
            localRestore: (file) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        actions.restoreFromBackup(backupData);
                        els.localRestoreStatus.textContent = '恢复成功!';
                        utils.ui.showToast('数据已从本地文件恢复');
                    } catch (error) {
                        els.localRestoreStatus.textContent = `恢复失败: ${error.message}`;
                        utils.ui.showToast(`恢复失败: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = function() {
                    els.localRestoreStatus.textContent = '读取文件时出错';
                    utils.ui.showToast('读取文件时出错', 'error');
                };
                
                reader.readAsText(file);
            },
            
            // 从备份数据恢复
            restoreFromBackup: (backupData) => {
                // 处理v1版本的备份文件兼容
                if (backupData.version === "1.0") {
                    // 旧版本只有单个prompts的数据
                    if (!backupData.prompts || !Array.isArray(backupData.prompts)) {
                        throw new Error('无效的备份数据: 找不到提示词数组');
                    }
                    
                    // 转换为新格式
                    const newData = {
                        tabs: ['prompts', 'macros'],
                        tabNames: {
                            'prompts': '提示词管理器',
                            'macros': '宏管理器'
                        },
                        tabData: {
                            'prompts': {
                                items: backupData.prompts,
                                categories: backupData.categories || ['默认', '工作', '学习', '创意']
                            },
                            'macros': {
                                items: [],
                                categories: ['默认', '工作', '学习', '创意']
                            }
                        }
                    };
                    
                    backupData = newData;
                } else {
                    // 新版本格式验证
                    if (!backupData.tabs || !backupData.tabNames || !backupData.tabData) {
                        throw new Error('无效的备份数据: 格式不正确');
                    }
                }
                
                // 恢复标签页配置
                tabSystem.tabs = backupData.tabs;
                tabSystem.tabNames = backupData.tabNames;
                
                // 恢复各标签页数据
                for (const tab in backupData.tabData) {
                    const tabData = backupData.tabData[tab];
                    
                    // 创建标签页数据结构
                    if (!tabSystem.data[tab]) {
                        tabSystem.data[tab] = {
                            items: [],
                            categories: ['默认', '工作', '学习', '创意'],
                            allTags: new Set()
                        };
                    }
                    
                    // 恢复项目和分类
                    tabSystem.data[tab].items = tabData.items;
                    tabSystem.data[tab].categories = tabData.categories;
                    
                    // 更新标签集合
                    tabSystem.data[tab].allTags.clear();
                    tabSystem.data[tab].items.forEach(item => {
                        if (item.tags && item.tags.length > 0) {
                            item.tags.forEach(tag => tabSystem.data[tab].allTags.add(tag));
                        }
                    });
                    
                    // 保存到本地存储
                    utils.storage.save(`${tab}_items`, tabSystem.data[tab].items);
                    utils.storage.save(`${tab}_categories`, tabSystem.data[tab].categories);
                }
                
                // 保存标签页配置
                utils.storage.save('tabs', {
                    tabs: tabSystem.tabs,
                    tabNames: tabSystem.tabNames
                });
                
                // 重新渲染标签页
                tabSystem.renderTabs();
                
                // 更新UI
                actions.updateCategoryOptions();
                actions.updateBulkCategoryOptions();
                actions.updateSidebarCategories();
                actions.updateSidebarTags();
                actions.applyFilterAndSort();
            }
        };

        // 事件监听器
        function setupEventListeners() {
            // 标签输入事件
            els.promptTagsInput.addEventListener('input', function() {
                const tags = utils.tags.parse(this.value);
                utils.tags.updateDisplay(tags, els.promptTagsContainer);
            });

            els.bulkTagsInput.addEventListener('input', function() {
                const tags = utils.tags.parse(this.value);
                utils.tags.updateDisplay(tags, els.bulkTagsContainer);
            });
            
            // 标签搜索事件
            els.tagSearchInput.addEventListener('input', actions.updateSidebarTags);
            els.clearTagSearch.addEventListener('click', () => {
                els.tagSearchInput.value = '';
                actions.updateSidebarTags();
            });
            
            els.tagManagerSearch.addEventListener('input', actions.updateTagsManagerList);
            els.clearTagManagerSearch.addEventListener('click', () => {
                els.tagManagerSearch.value = '';
                actions.updateTagsManagerList();
            });
            
            // 拖放区域事件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                els.dropArea.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                els.dropArea.addEventListener(eventName, () => {
                    els.dropArea.classList.add('highlight');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                els.dropArea.addEventListener(eventName, () => {
                    els.dropArea.classList.remove('highlight');
                }, false);
            });

            els.dropArea.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                for (let i = 0; i < files.length; i++) {
                    if (files[i].name.endsWith('.md')) {
                        actions.createItemFromMarkdown(files[i]);
                    }
                }
            }, false);

            // 文件选择按钮
            els.fileSelectBtn.addEventListener('click', () => {
                els.fileInput.click();
            });

            els.fileInput.addEventListener('change', () => {
                if (els.fileInput.files.length > 0) {
                    for (let i = 0; i < els.fileInput.files.length; i++) {
                        if (els.fileInput.files[i].name.endsWith('.md')) {
                            actions.createItemFromMarkdown(els.fileInput.files[i]);
                        }
                    }
                    els.fileInput.value = '';
                }
            });

            // 备份恢复相关事件
            els.backupMenuBtn.addEventListener('click', () => {
                els.backupModal.style.display = 'flex';
            });
            
            els.restoreMenuBtn.addEventListener('click', () => {
                els.restoreModal.style.display = 'flex';
                els.localRestoreStatus.textContent = '';
            });
            
            els.closeBackupModal.addEventListener('click', () => {
                els.backupModal.style.display = 'none';
            });
            
            els.closeRestoreModal.addEventListener('click', () => {
                els.restoreModal.style.display = 'none';
            });
            
            els.localBackupBtn.addEventListener('click', actions.localBackup);
            
            els.restoreFileInput.addEventListener('change', () => {
                if (els.restoreFileInput.files.length > 0) {
                    actions.localRestore(els.restoreFileInput.files[0]);
                    els.restoreFileInput.value = '';
                }
            });
            
            // 视图切换按钮
            els.cardViewBtn.addEventListener('click', () => {
                state.currentView = 'card';
                state.saveTabState();
                actions.updateViewMode();
            });

            els.listViewBtn.addEventListener('click', () => {
                state.currentView = 'list';
                state.saveTabState();
                actions.updateViewMode();
            });

            // 排序选项变化
            els.sortOptions.addEventListener('change', () => {
                state.currentSort = els.sortOptions.value;
                state.saveTabState();
                actions.applyFilterAndSort();
            });

            // 分组选项变化
            els.groupOptions.addEventListener('change', () => {
                state.currentGroup = els.groupOptions.value;
                state.saveTabState();
                actions.applyFilterAndSort();
            });

            // 新建项目按钮
            els.newItemBtn.addEventListener('click', () => {
                utils.ui.showModal();
            });

            // 管理分类按钮
            els.manageCategoriesBtn.addEventListener('click', () => {
                actions.renderCategoryList();
                els.categoryManager.style.display = 'flex';
            });

            // 管理标签按钮
            els.manageTagsBtn.addEventListener('click', () => {
                actions.updateTagsManagerList();
                els.tagsManager.style.display = 'flex';
            });

            // 关闭分类管理器
            els.closeCategoryManager.addEventListener('click', () => {
                els.categoryManager.style.display = 'none';
            });

            // 关闭标签管理器
            els.closeTagsManager.addEventListener('click', () => {
                els.tagsManager.style.display = 'none';
            });

            // 添加分类按钮
            els.addCategoryBtn.addEventListener('click', () => {
                const newCategory = els.newCategoryInput.value.trim();
                if (newCategory) {
                    actions.addCategory(newCategory);
                    els.newCategoryInput.value = '';
                }
            });

            // 添加标签按钮
            els.addTagBtn.addEventListener('click', () => {
                const newTag = els.newTagInput.value.trim();
                if (newTag) {
                    actions.addTag(newTag);
                    els.newTagInput.value = '';
                }
            });

            // 新分类输入框回车事件
            els.newCategoryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const newCategory = els.newCategoryInput.value.trim();
                    if (newCategory) {
                        actions.addCategory(newCategory);
                        els.newCategoryInput.value = '';
                    }
                }
            });

            // 新标签输入框回车事件
            els.newTagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const newTag = els.newTagInput.value.trim();
                    if (newTag) {
                        actions.addTag(newTag);
                        els.newTagInput.value = '';
                    }
                }
            });

            // 关闭模态框
            els.closeModalBtn.addEventListener('click', () => {
                els.modal.style.display = 'none';
            });

            // 关闭批量操作模态框
            els.closeMultiActionModal.addEventListener('click', () => {
                els.multiActionModal.style.display = 'none';
            });

            // 关闭标签管理模态框
            els.closeTagsModal.addEventListener('click', () => {
                els.tagsModal.style.display = 'none';
            });

            // 关闭新标签页模态框
            els.closeTabModal.addEventListener('click', () => {
                els.tabModal.style.display = 'none';
            });

            // 添加新标签页按钮
            els.addTabBtn.addEventListener('click', () => {
                const tabName = els.newTabName.value.trim();
                if (tabSystem.addTab(tabName)) {
                    els.tabModal.style.display = 'none';
                }
            });

            // 新标签页名称输入框回车事件
            els.newTabName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const tabName = els.newTabName.value.trim();
                    if (tabSystem.addTab(tabName)) {
                        els.tabModal.style.display = 'none';
                    }
                }
            });

            // 全局点击关闭模态框
            window.addEventListener('click', (e) => {
                if (e.target === els.modal) els.modal.style.display = 'none';
                if (e.target === els.categoryManager) els.categoryManager.style.display = 'none';
                if (e.target === els.multiActionModal) els.multiActionModal.style.display = 'none';
                if (e.target === els.tagsModal) els.tagsModal.style.display = 'none';
                if (e.target === els.tagsManager) els.tagsManager.style.display = 'none';
                if (e.target === els.backupModal) els.backupModal.style.display = 'none';
                if (e.target === els.restoreModal) els.restoreModal.style.display = 'none';
                if (e.target === els.tabModal) els.tabModal.style.display = 'none';
            });

            // 保存项目
            els.savePromptBtn.addEventListener('click', () => {
                const title = els.promptTitleInput.value.trim();
                const content = els.promptContentInput.value.trim();
                const category = els.promptCategoryInput.value;
                const tags = utils.tags.parse(els.promptTagsInput.value);
                
                if (!title || !content) {
                    utils.ui.showToast('标题和内容不能为空', 'warning');
                    return;
                }
                
                if (state.editingIndex >= 0) {
                    utils.data.updateItem(state.editingIndex, title, content, category, tags);
                    utils.ui.showToast('项目已更新');
                } else {
                    utils.data.addItem(title, content, category, tags);
                    utils.ui.showToast('项目已添加');
                }
                
                els.modal.style.display = 'none';
            });

            // 搜索输入
            els.searchInput.addEventListener('input', () => {
                actions.applyFilterAndSort();
            });

            // 多选模式相关事件
            els.selectModeBtn.addEventListener('click', actions.toggleSelectMode);
            els.cancelSelectBtn.addEventListener('click', actions.toggleSelectMode);
            els.bulkDeleteBtn.addEventListener('click', actions.bulkDeleteItems);
            els.bulkCategoryBtn.addEventListener('click', actions.showBulkCategoryModal);
            els.bulkTagsBtn.addEventListener('click', actions.showBulkTagsModal);
            els.applyBulkCategoryBtn.addEventListener('click', actions.applyBulkCategory);
            els.applyBulkTagsBtn.addEventListener('click', actions.applyBulkTags);

            // 移动设备菜单切换
            els.menuToggle.addEventListener('click', () => {
                els.sidebar.classList.toggle('active');
            });

            // 窗口调整大小时处理侧边栏
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    els.sidebar.classList.remove('active');
                }
            });
        }

        // 初始化应用
        actions.init();
    </script>
</body>
</html>
